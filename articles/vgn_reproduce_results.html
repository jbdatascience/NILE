<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reproduce paper results â€¢ NILE</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Reproduce paper results">
<meta property="og:description" content="NILE">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">NILE</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/vgn_reproduce_results.html">Reproduce paper results</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/runesen/NILE/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="vgn_reproduce_results_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Reproduce paper results</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/runesen/NILE/blob/master/vignettes/vgn_reproduce_results.Rmd"><code>vignettes/vgn_reproduce_results.Rmd</code></a></small>
      <div class="hidden name"><code>vgn_reproduce_results.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>This vignette will guide you through reproducing the numerical simulations and figures of <span class="citation">Christiansen et al. (2020)</span>. Each section is devoted to reproducing each image or simulation. Once <code>NILE</code> is installed, you can export the code in this guide by typing <code><a href="https://rdrr.io/r/utils/edit.html">edit(vignette("vgn_reproduce_results"))</a></code>.</p>
</div>
<div id="figure-1---impossibility-plots" class="section level2">
<h2 class="hasAnchor">
<a href="#figure-1---impossibility-plots" class="anchor"></a>Figure 1 - Impossibility plots</h2>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">gridExtra</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">grid</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>())


<span class="kw">join.smoothly</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">x</span>,<span class="kw">x1</span>,<span class="kw">x2</span>,<span class="kw">f1</span>,<span class="kw">f2</span>,<span class="kw">f1prime</span>,<span class="kw">f2prime</span>){
  <span class="kw">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">f1</span>,<span class="kw">f2</span>,<span class="kw">f1prime</span>,<span class="kw">f2prime</span>)
  <span class="kw">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="kw">x1</span>,<span class="kw">x1</span><span class="op">^</span><span class="fl">2</span>,<span class="kw">x1</span><span class="op">^</span><span class="fl">3</span>,
                <span class="fl">1</span>,<span class="kw">x2</span>,<span class="kw">x2</span><span class="op">^</span><span class="fl">2</span>,<span class="kw">x2</span><span class="op">^</span><span class="fl">3</span>,
                <span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">*</span><span class="kw">x1</span>,<span class="fl">3</span><span class="op">*</span><span class="kw">x1</span><span class="op">^</span><span class="fl">2</span>,
                <span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">*</span><span class="kw">x2</span>,<span class="fl">3</span><span class="op">*</span><span class="kw">x2</span><span class="op">^</span><span class="fl">2</span>), <span class="fl">4</span>,<span class="fl">4</span>, byrow=<span class="fl">TRUE</span>)
  <span class="kw">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span>(<span class="kw">A</span>,<span class="kw">y</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="kw">x</span>, <span class="fu">function</span>(<span class="kw">xx</span>) <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">b</span><span class="op">*</span>(<span class="kw">xx</span><span class="op">^</span>(<span class="fl">0</span><span class="op">:</span><span class="fl">3</span>))))
}

<span class="kw">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">.01</span>)
<span class="co"># plot(x,join.smoothly(x,0,1,-1,1))</span>

<span class="kw">g.global</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">a</span>) <span class="kw">a</span><span class="op">+</span><span class="fl">1</span>
<span class="kw">g.global.prime</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">a</span>) <span class="fl">1</span>

<span class="kw">g</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">a</span>, <span class="kw">supp</span> = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>), <span class="kw">eps</span> = <span class="fl">.5</span>, <span class="kw">C</span>=<span class="fl">5</span>){
  <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">a</span>))
  <span class="kw">w.below</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">a</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">supp</span>)<span class="op">-</span><span class="kw">eps</span>)
  <span class="kw">w.midlow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">a</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">supp</span>)<span class="op">-</span><span class="kw">eps</span> <span class="op">&amp;</span> <span class="kw">a</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">supp</span>))
  <span class="kw">w.within</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">a</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">supp</span>) <span class="op">&amp;</span> <span class="kw">a</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">supp</span>))
  <span class="kw">w.midup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">a</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">supp</span>) <span class="op">&amp;</span> <span class="kw">a</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">supp</span>)<span class="op">+</span><span class="kw">eps</span>)
  <span class="kw">w.above</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">a</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">supp</span>)<span class="op">+</span><span class="kw">eps</span>)
  <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">w.below</span>)<span class="op">&gt;</span><span class="fl">0</span>) <span class="kw">out</span>[<span class="kw">w.below</span>] <span class="op">&lt;-</span> <span class="kw">out</span>[<span class="kw">w.above</span>] <span class="op">&lt;-</span> <span class="kw">C</span>
  <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">w.midlow</span>)<span class="op">&gt;</span><span class="fl">0</span>) <span class="kw">out</span>[<span class="kw">w.midlow</span>] <span class="op">&lt;-</span> <span class="fu">join.smoothly</span>(<span class="kw">a</span>[<span class="kw">w.midlow</span>],<span class="kw">supp</span>[<span class="fl">1</span>]<span class="op">-</span><span class="kw">eps</span>,<span class="kw">supp</span>[<span class="fl">1</span>],<span class="kw">C</span>,<span class="fu">g.global</span>(<span class="kw">supp</span>[<span class="fl">1</span>]),<span class="fl">0</span>,<span class="fu">g.global.prime</span>(<span class="kw">supp</span>[<span class="fl">2</span>]))
  <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">w.within</span>)<span class="op">&gt;</span><span class="fl">0</span>) <span class="kw">out</span>[<span class="kw">w.within</span>] <span class="op">&lt;-</span> <span class="fu">g.global</span>(<span class="kw">a</span>[<span class="kw">w.within</span>])
  <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">w.midup</span>)<span class="op">&gt;</span><span class="fl">0</span>) <span class="kw">out</span>[<span class="kw">w.midup</span>] <span class="op">&lt;-</span> <span class="fu">join.smoothly</span>(<span class="kw">a</span>[<span class="kw">w.midup</span>],<span class="kw">supp</span>[<span class="fl">2</span>], <span class="kw">supp</span>[<span class="fl">2</span>]<span class="op">+</span><span class="kw">eps</span>,<span class="fu">g.global</span>(<span class="kw">supp</span>[<span class="fl">2</span>]),<span class="kw">C</span>, <span class="fu">g.global.prime</span>(<span class="kw">supp</span>[<span class="fl">2</span>]),<span class="fl">0</span>)
  <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">w.above</span>)<span class="op">&gt;</span><span class="fl">0</span>) <span class="kw">out</span>[<span class="kw">w.above</span>] <span class="op">&lt;-</span> <span class="kw">C</span>
  <span class="kw">out</span>
}
<span class="kw">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="fl">2</span>,<span class="fl">2</span>,length.out = <span class="fl">1000</span>)
<span class="co"># plot(a,g(a,eps=.5),type="l",lwd=5)</span>

<span class="kw">n</span> <span class="op">&lt;-</span> <span class="fl">200</span>
<span class="kw">beta</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)
<span class="co"># observational</span>
<span class="kw">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw">n</span>)
<span class="kw">X</span> <span class="op">&lt;-</span> <span class="fu">g</span>(<span class="kw">A</span>, eps=<span class="fl">.5</span>, C=<span class="fl">5</span>) <span class="op">+</span> <span class="kw">H</span> <span class="op">+</span> <span class="fl">.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw">n</span>)
<span class="kw">Y</span> <span class="op">&lt;-</span> <span class="kw">beta</span><span class="op">*</span><span class="kw">X</span> <span class="op">+</span> <span class="kw">H</span> <span class="op">+</span> <span class="fl">.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw">n</span>)

<span class="kw">bOLS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="kw">Y</span><span class="op">~</span><span class="kw">X</span>)<span class="op">$</span><span class="kw">coefficients</span>

<span class="co"># interventional</span>
<span class="kw">Ai</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1.5</span>,<span class="kw">n</span>)
<span class="kw">Hi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw">n</span>)
<span class="kw">Xi</span> <span class="op">&lt;-</span> <span class="fu">g</span>(<span class="kw">Ai</span>, eps=<span class="fl">.5</span>, C=<span class="fl">5</span>) <span class="op">+</span> <span class="kw">Hi</span> <span class="op">+</span> <span class="fl">.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw">n</span>)
<span class="kw">Yi</span> <span class="op">&lt;-</span> <span class="kw">beta</span><span class="op">*</span><span class="kw">Xi</span> <span class="op">+</span> <span class="kw">Hi</span> <span class="op">+</span> <span class="fl">.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw">n</span>)

<span class="kw">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(X=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">X</span>,<span class="kw">Xi</span>), A=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">A</span>,<span class="kw">Ai</span>), Y=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">Y</span>,<span class="kw">Yi</span>),
                 setting = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"observational"</span>, <span class="st">"interventional"</span>), each=<span class="kw">n</span>),
                                  levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"observational"</span>, <span class="st">"interventional"</span>)))
<span class="kw">x.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">df</span><span class="op">$</span><span class="kw">X</span>), <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">df</span><span class="op">$</span><span class="kw">X</span>), length.out = <span class="fl">100</span>)
<span class="kw">df.line</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(x = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw">x.seq</span>, <span class="fl">2</span>),
                      y = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">bOLS</span>[<span class="fl">1</span>] <span class="op">+</span> <span class="kw">bOLS</span>[<span class="fl">2</span>]<span class="op">*</span><span class="kw">x.seq</span>,
                            <span class="kw">x.seq</span>),
                      model = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"candidate"</span>, <span class="st">"causal"</span>), each = <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.seq</span>))))

<span class="kw">pXY</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(data=<span class="kw">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">X</span>,<span class="kw">Y</span>, col=<span class="kw">setting</span>, shape = <span class="kw">setting</span>), alpha=<span class="fl">.7</span>, size=<span class="fl">3</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"black"</span>, <span class="st">"red"</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(data=<span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">df.line</span>, <span class="kw">model</span> <span class="op">==</span> <span class="st">"candidate"</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span>,<span class="kw">y</span>),size=<span class="fl">1</span>, col = <span class="st">"blue"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(data=<span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">df.line</span>, <span class="kw">model</span> <span class="op">==</span> <span class="st">"causal"</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span>,<span class="kw">y</span>),size=<span class="fl">1</span>, col = <span class="st">"#009E73"</span>, lty = <span class="st">"dashed"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(geom = <span class="st">"text"</span>, x = <span class="op">-</span><span class="fl">1</span>, y = <span class="fl">5</span>, label = <span class="st">"training data"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(geom = <span class="st">"text"</span>, x = <span class="fl">5</span>, y = <span class="op">-</span><span class="fl">1</span>, label = <span class="st">"test data"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(geom = <span class="st">"text"</span>, x = <span class="fl">3</span>, y = <span class="fl">10</span>, label = <span class="st">"candidate model"</span>) <span class="op">+</span>
  <span class="co"># annotate(geom = "text", x = 6, y = 1, label = "causal model") +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(geom = <span class="st">"text"</span>, x = <span class="fl">7.5</span>, y = <span class="fl">6.5</span>, label = <span class="st">"f"</span>, col = <span class="st">"#009E73"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x = <span class="op">-</span><span class="fl">.5</span>, y = <span class="fl">4</span>, xend = <span class="fl">0</span>, yend =<span class="fl">2</span>),
               arrow = <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span>(length = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>))) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x = <span class="fl">5</span>, y = <span class="fl">0</span>, xend = <span class="fl">5</span>, yend = <span class="fl">2</span>),
               arrow = <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span>(length = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>))) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x = <span class="fl">5</span>, y = <span class="fl">10</span>, xend = <span class="fl">6</span>, yend = <span class="fl">10</span>),
               arrow = <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span>(length = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>))) <span class="op">+</span>
  <span class="co"># geom_segment(aes(x = 6, y = 2, xend = 6.6, yend = 6.3),</span>
  <span class="co">#              arrow = arrow(length = unit(0.3, "cm"))) +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"x"</span>) <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"y"</span>) <span class="op">+</span>
  <span class="co"># geom_abline(intercept = bOLS[1], slope = bOLS[2]) +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(legend.position = <span class="st">"none"</span>,
        text = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size=<span class="fl">15</span>),
        plot.title = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size = <span class="fl">14</span>, hjust=<span class="fl">.5</span>))

<span class="kw">a.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="fl">2</span>,<span class="fl">2</span>,length.out = <span class="fl">1000</span>)
<span class="kw">df.A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(a = <span class="kw">a.seq</span>, g = <span class="fu">g</span>(<span class="kw">a.seq</span>))
<span class="kw">df.A</span><span class="op">$</span><span class="kw">seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">df.A</span>), <span class="fu">function</span>(<span class="kw">i</span>) <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">df.A</span><span class="op">$</span><span class="kw">a</span>[<span class="kw">i</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">df.A</span><span class="op">$</span><span class="kw">a</span>[<span class="kw">i</span>] <span class="op">&lt;=</span> <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>))))

<span class="kw">grid.a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="fl">.9</span>, <span class="fl">.9</span>, <span class="fl">.2</span>)
<span class="kw">hist.a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="kw">grid.a</span>, <span class="fu">function</span>(<span class="kw">g</span>) <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">A</span><span class="op">-</span><span class="kw">g</span>) <span class="op">&lt;</span> <span class="fl">.1</span>))
<span class="kw">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">hist.a</span>)
<span class="kw">hist.a</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">*</span><span class="kw">hist.a</span><span class="op">/</span><span class="kw">m</span>
<span class="kw">df.hist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(a=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">grid.a</span>, <span class="fl">1.55</span>), h = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">hist.a</span>, <span class="fl">4</span>), data = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"1"</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">grid.a</span>)), <span class="st">"2"</span>))

<span class="kw">pA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">df.A</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">a</span>,<span class="kw">g</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x = <span class="fl">1</span>, y = <span class="fl">.8</span>, xend = <span class="fl">1.4</span>, yend = <span class="fl">.1</span>),
               arrow = <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span>(length = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>))) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(lty = <span class="kw">seq</span>), size=<span class="fl">1</span>, col = <span class="st">"black"</span>) <span class="op">+</span>
  <span class="co"># geom_line(size=1, col = "black") +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"a"</span>) <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">""</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(data=<span class="kw">df.hist</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x=<span class="kw">a</span>,y=<span class="kw">h</span>,fill=<span class="kw">data</span>), alpha=<span class="fl">.2</span>, stat = <span class="st">"identity"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(geom = <span class="st">"text"</span>, x = <span class="op">-</span><span class="fl">1.6</span>, y = <span class="fl">4.5</span>, label = <span class="st">"g"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x = <span class="op">-</span><span class="fl">.8</span>, y = <span class="fl">3.5</span>, xend = <span class="op">-</span><span class="fl">1</span>, yend = <span class="fl">3.5</span>),
               arrow = <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span>(length = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>), angle = <span class="fl">90</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x = <span class="fl">.8</span>, y = <span class="fl">3.5</span>, xend = <span class="fl">1</span>, yend = <span class="fl">3.5</span>),
               arrow = <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span>(length = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>), angle = <span class="fl">90</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(geom = <span class="st">"text"</span>, x = <span class="fl">0</span>, y = <span class="fl">3.5</span>, label = <span class="st">"training support"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(geom = <span class="st">"text"</span>, x = <span class="fl">.9</span>, y = <span class="fl">1</span>, label = <span class="st">"intervention"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span>(values= <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"black"</span>, <span class="st">"red"</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_linetype_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"dashed"</span>, <span class="st">"solid"</span>, <span class="st">"dashed"</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(legend.position = <span class="st">"none"</span>,
        text = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size=<span class="fl">15</span>),
        plot.title = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size = <span class="fl">14</span>, hjust=<span class="fl">.5</span>))

<span class="kw">all.A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">arrangeGrob</a></span>(<span class="kw">pA</span>, <span class="kw">pXY</span>, ncol = <span class="fl">2</span>,
                     top = <span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html">textGrob</a></span>(<span class="st">"support-extending interventions on A"</span>, gp=<span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span>(fontsize=<span class="fl">15</span>)))

<span class="co"># # grid.arrange(pA, pXY, ncol=2)</span>
<span class="co">#</span>
<span class="co"># pdf("../figures/impossibility_AtoX_nonlinear.pdf", width = 8, height = 3.5)</span>
<span class="co"># grid.arrange(pA, pXY, ncol=2, top = "support-extending interventions on A")</span>
<span class="co"># dev.off()</span>



<span class="co">#######################</span>
<span class="co">## interventions on X</span>
<span class="co">#######################</span>
<span class="kw">f.global</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">x</span>) <span class="op">-</span><span class="kw">x</span>
<span class="kw">f.global.prime</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">x</span>) <span class="op">-</span><span class="fl">1</span>

<span class="kw">f</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">a</span>, <span class="kw">supp</span> = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>), <span class="kw">eps</span> = <span class="fl">1</span>, <span class="kw">C</span>=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">5</span>,<span class="fl">5</span>)){
  <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">a</span>))
  <span class="kw">w.below</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">a</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">supp</span>)<span class="op">-</span><span class="kw">eps</span>)
  <span class="kw">w.midlow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">a</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">supp</span>)<span class="op">-</span><span class="kw">eps</span> <span class="op">&amp;</span> <span class="kw">a</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">supp</span>))
  <span class="kw">w.within</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">a</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">supp</span>) <span class="op">&amp;</span> <span class="kw">a</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">supp</span>))
  <span class="kw">w.midup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">a</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">supp</span>) <span class="op">&amp;</span> <span class="kw">a</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">supp</span>)<span class="op">+</span><span class="kw">eps</span>)
  <span class="kw">w.above</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">a</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">supp</span>)<span class="op">+</span><span class="kw">eps</span>)
  <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">w.below</span>)<span class="op">&gt;</span><span class="fl">0</span>) <span class="kw">out</span>[<span class="kw">w.below</span>] <span class="op">&lt;-</span> <span class="kw">C</span>[<span class="fl">1</span>]
  <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">w.midlow</span>)<span class="op">&gt;</span><span class="fl">0</span>) <span class="kw">out</span>[<span class="kw">w.midlow</span>] <span class="op">&lt;-</span> <span class="fu">join.smoothly</span>(<span class="kw">a</span>[<span class="kw">w.midlow</span>],<span class="kw">supp</span>[<span class="fl">1</span>]<span class="op">-</span><span class="kw">eps</span>,<span class="kw">supp</span>[<span class="fl">1</span>],<span class="kw">C</span>[<span class="fl">1</span>],<span class="fu">f.global</span>(<span class="kw">supp</span>[<span class="fl">1</span>]),<span class="fl">20</span>,<span class="fu">f.global.prime</span>(<span class="kw">supp</span>[<span class="fl">2</span>]))
  <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">w.within</span>)<span class="op">&gt;</span><span class="fl">0</span>) <span class="kw">out</span>[<span class="kw">w.within</span>] <span class="op">&lt;-</span> <span class="fu">f.global</span>(<span class="kw">a</span>[<span class="kw">w.within</span>])
  <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">w.midup</span>)<span class="op">&gt;</span><span class="fl">0</span>) <span class="kw">out</span>[<span class="kw">w.midup</span>] <span class="op">&lt;-</span> <span class="fu">join.smoothly</span>(<span class="kw">a</span>[<span class="kw">w.midup</span>],<span class="kw">supp</span>[<span class="fl">2</span>],<span class="kw">supp</span>[<span class="fl">2</span>]<span class="op">+</span><span class="kw">eps</span>,<span class="fu">f.global</span>(<span class="kw">supp</span>[<span class="fl">2</span>]),<span class="kw">C</span>[<span class="fl">2</span>], <span class="fu">f.global.prime</span>(<span class="kw">supp</span>[<span class="fl">2</span>]),<span class="fl">20</span>)
  <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">w.above</span>)<span class="op">&gt;</span><span class="fl">0</span>) <span class="kw">out</span>[<span class="kw">w.above</span>] <span class="op">&lt;-</span> <span class="kw">C</span>[<span class="fl">2</span>]
  <span class="kw">out</span>
}
<span class="kw">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="fl">2</span>,<span class="fl">2</span>,length.out = <span class="fl">1000</span>)
<span class="co"># plot(x,f(x,eps=1),type="l",lwd=5)</span>

<span class="kw">n</span> <span class="op">&lt;-</span> <span class="fl">200</span>
<span class="kw">beta</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)
<span class="co"># observational</span>
<span class="kw">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">X</span> <span class="op">&lt;-</span> <span class="fl">.4</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="fl">.4</span><span class="op">*</span><span class="kw">A</span> <span class="op">+</span> <span class="fl">.2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">Y</span> <span class="op">&lt;-</span> <span class="fu">f</span>(<span class="kw">X</span>) <span class="op">+</span> <span class="fl">.5</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="fl">.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw">n</span>)

<span class="kw">Ai</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">Hi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">Xi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="fl">1.5</span>,<span class="fl">2</span>)
<span class="kw">Yi</span> <span class="op">&lt;-</span> <span class="fu">f</span>(<span class="kw">Xi</span>) <span class="op">+</span> <span class="kw">Hi</span> <span class="op">+</span> <span class="fl">.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw">n</span>)


<span class="kw">df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(X=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">X</span>,<span class="kw">Xi</span>), A=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">A</span>,<span class="kw">Ai</span>), Y=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">Y</span>,<span class="kw">Yi</span>),
                 setting = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"observational"</span>, <span class="st">"interventional"</span>), each=<span class="kw">n</span>),
                                  levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"observational"</span>, <span class="st">"interventional"</span>)))
<span class="kw">x.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="fl">2</span>,<span class="fl">2</span>,length.out = <span class="fl">1000</span>)
<span class="kw">df1.line</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(x = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw">x.seq</span>, <span class="fl">2</span>),
                      y = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="kw">x.seq</span>, <span class="fu">f</span>(<span class="kw">x.seq</span>)),
                      model = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"candidate"</span>, <span class="st">"causal"</span>), each = <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.seq</span>))))

<span class="kw">pXY1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(data=<span class="kw">df1</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">X</span>,<span class="kw">Y</span>, col=<span class="kw">setting</span>, shape = <span class="kw">setting</span>), alpha=<span class="fl">.7</span>, size=<span class="fl">3</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"black"</span>, <span class="st">"red"</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(data=<span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">df1.line</span>, <span class="kw">model</span> <span class="op">==</span> <span class="st">"candidate"</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span>,<span class="kw">y</span>),size=<span class="fl">1</span>, col = <span class="st">"blue"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(data=<span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">df1.line</span>, <span class="kw">model</span> <span class="op">==</span> <span class="st">"causal"</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span>,<span class="kw">y</span>),size=<span class="fl">1</span>, col = <span class="st">"#009E73"</span>, lty = <span class="st">"dashed"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(geom = <span class="st">"text"</span>, x = <span class="fl">0</span>, y = <span class="fl">3.5</span>, label = <span class="st">"training data"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(geom = <span class="st">"text"</span>, x = <span class="fl">1</span>, y = <span class="fl">5.5</span>, label = <span class="st">"test data"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(geom = <span class="st">"text"</span>, x = <span class="op">-</span><span class="fl">1.2</span>, y = <span class="fl">5.5</span>, label = <span class="st">"candidate model"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(geom = <span class="st">"text"</span>, x = <span class="op">-</span><span class="fl">1.5</span>, y = <span class="op">-</span><span class="fl">1</span>, label = <span class="st">"f"</span>, col = <span class="st">"#009E73"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"support-extending interventions on X"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"x"</span>) <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"y"</span>) <span class="op">+</span>
  <span class="co"># annotate(geom = "text", x = 6, y = 1, label = "causal model") +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x = <span class="fl">0</span>, y = <span class="fl">3</span>, xend = <span class="fl">0</span>, yend = <span class="fl">1.5</span>),
               arrow = <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span>(length = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>))) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x = <span class="fl">1.2</span>, y = <span class="fl">5</span>, xend = <span class="fl">1.6</span>, yend = <span class="fl">4</span>),
               arrow = <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span>(length = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>))) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x = <span class="op">-</span><span class="fl">1.2</span>, y = <span class="fl">5</span>, xend = <span class="op">-</span><span class="fl">1.6</span>, yend = <span class="fl">2.5</span>),
               arrow = <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span>(length = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>))) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x = <span class="op">-</span><span class="fl">.8</span>, y = <span class="op">-</span><span class="fl">5</span>, xend = <span class="op">-</span><span class="fl">1</span>, yend = <span class="op">-</span><span class="fl">5</span>),
               arrow = <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span>(length = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>), angle = <span class="fl">90</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x = <span class="fl">.8</span>, y = <span class="op">-</span><span class="fl">5</span>, xend = <span class="fl">1</span>, yend = <span class="op">-</span><span class="fl">5</span>),
               arrow = <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span>(length = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>), angle = <span class="fl">90</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x = <span class="fl">1.5</span>, y = <span class="op">-</span><span class="fl">5</span>, xend = <span class="fl">2</span>, yend = <span class="op">-</span><span class="fl">5</span>),
               arrow = <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span>(length = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>), angle = <span class="fl">90</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x = <span class="fl">2</span>, y = <span class="op">-</span><span class="fl">5</span>, xend = <span class="fl">1.5</span>, yend = <span class="op">-</span><span class="fl">5</span>),
               arrow = <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span>(length = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>), angle = <span class="fl">90</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(geom = <span class="st">"text"</span>, x = <span class="fl">0</span>, y = <span class="op">-</span><span class="fl">5</span>, label = <span class="st">"training support"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span>(ylim=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">5.5</span>,<span class="fl">6</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(geom = <span class="st">"text"</span>, x = <span class="fl">1.5</span>, y = <span class="op">-</span><span class="fl">3.5</span>, label = <span class="st">"test support"</span>) <span class="op">+</span>
  <span class="co"># geom_segment(aes(x = 1, y = -3.5, xend = 1.5, yend = -4),</span>
  <span class="co">#              arrow = arrow(length = unit(0.3, "cm"))) +</span>
  <span class="co"># xlab("x") + ylab("y") +</span>
  <span class="co"># geom_abline(intercept = bOLS[1], slope = bOLS[2]) +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(legend.position = <span class="st">"none"</span>,
        text = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size=<span class="fl">15</span>),
        plot.title = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size = <span class="fl">14</span>, hjust=<span class="fl">.5</span>))

<span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="kw">pXY1</span>, <span class="kw">all.A</span>,ncol=<span class="fl">2</span>, widths = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>))
</pre></div>
<p><img src="vgn_reproduce_results_files/figure-html/plot-impossibility-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div id="figure-2---nile-vs--other-methods" class="section level2">
<h2 class="hasAnchor">
<a href="#figure-2---nile-vs--other-methods" class="anchor"></a>Figure 2 - NILE vs.Â other methods</h2>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/runesen/NILE">NILE</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/HenrikBengtsson/R.utils">R.utils</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">splines</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">np</span>)
<span class="co"># X has fixed variance 1/3</span>
<span class="kw">n</span> <span class="op">&lt;-</span> <span class="fl">200</span>
<span class="kw">fact</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># three times the desired variance of X</span>
<span class="kw">df.X</span> <span class="op">&lt;-</span> <span class="fl">50</span>
<span class="co">## missing settings</span>
<span class="kw">alphaA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="kw">fact</span><span class="op">/</span><span class="fl">3</span>)
<span class="kw">alphaH</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">2</span><span class="op">*</span><span class="kw">fact</span><span class="op">/</span><span class="fl">3</span>)
<span class="kw">alphaEps</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="co">## quantiles for different settings</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)
<span class="kw">N</span> <span class="op">&lt;-</span> <span class="fl">100000</span>
<span class="kw">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">X</span> <span class="op">&lt;-</span> <span class="kw">alphaA</span><span class="op">*</span><span class="kw">A</span> <span class="op">+</span> <span class="kw">alphaH</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="kw">alphaEps</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="kw">X</span>, probs = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.05</span>,<span class="fl">.95</span>))
<span class="kw">qX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)<span class="op">*</span>(<span class="kw">q</span>[<span class="fl">2</span>]<span class="op">-</span><span class="kw">q</span>[<span class="fl">1</span>])<span class="op">/</span><span class="fl">2</span>
<span class="kw">suppX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)<span class="op">*</span>(<span class="kw">alphaA</span> <span class="op">+</span> <span class="kw">alphaH</span> <span class="op">+</span> <span class="kw">alphaEps</span>)

<span class="kw">n.splines.true</span> <span class="op">&lt;-</span> <span class="fl">4</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">4</span>)
<span class="kw">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n.splines.true</span>, <span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">fX</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">x</span>=<span class="kw">x.new</span>, <span class="kw">qx</span>=<span class="kw">qX</span>, <span class="kw">beta</span>=<span class="kw">beta</span>){
  <span class="kw">bx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html">ns</a></span>(<span class="kw">x</span>, knots = <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(from=<span class="kw">qx</span>[<span class="fl">1</span>], to=<span class="kw">qx</span>[<span class="fl">2</span>], length.out=(<span class="kw">n.splines.true</span><span class="op">+</span><span class="fl">1</span>))[<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="kw">n.splines.true</span><span class="op">+</span><span class="fl">1</span>)], Boundary.knots = <span class="kw">qx</span>)
  <span class="kw">bx</span><span class="op">%*%</span><span class="kw">beta</span>
}
<span class="kw">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">X</span> <span class="op">&lt;-</span> <span class="kw">alphaA</span><span class="op">*</span><span class="kw">A</span> <span class="op">+</span> <span class="kw">alphaH</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="kw">alphaEps</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">Y</span> <span class="op">&lt;-</span> <span class="fu">fX</span>(<span class="kw">X</span>,<span class="kw">qX</span>,<span class="kw">beta</span>) <span class="op">+</span> <span class="fl">.3</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="fl">.2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">x.new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="fl">2</span>,<span class="fl">2</span>,length.out = <span class="fl">100</span>)
<span class="kw">f.new</span> <span class="op">&lt;-</span> <span class="fu">fX</span>(<span class="kw">x.new</span>, <span class="kw">qX</span>, <span class="kw">beta</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span>(<span class="kw">X</span>,<span class="kw">Y</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="kw">x.new</span>, <span class="kw">f.new</span>)

<span class="kw">pred.frame</span> <span class="op">&lt;-</span> <span class="kw">NULL</span>
<span class="kw">k</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="kw">Nsim</span> <span class="op">&lt;-</span> <span class="fl">20</span>
<span class="co">for</span>(<span class="kw">i</span> <span class="co">in</span> <span class="fl">1</span><span class="op">:</span><span class="kw">Nsim</span>){
  <span class="kw">k</span> <span class="op">&lt;-</span> <span class="kw">k</span><span class="op">+</span><span class="fl">1</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="kw">k</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"sim = "</span>, <span class="kw">i</span>))

  <span class="kw">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
  <span class="kw">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
  <span class="kw">X</span> <span class="op">&lt;-</span> <span class="kw">alphaA</span><span class="op">*</span><span class="kw">A</span> <span class="op">+</span> <span class="kw">alphaH</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="kw">alphaEps</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
  <span class="kw">Y</span> <span class="op">&lt;-</span> <span class="fu">fX</span>(<span class="kw">X</span>,<span class="kw">qX</span>,<span class="kw">beta</span>) <span class="op">+</span> <span class="fl">.3</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="fl">.2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)

  <span class="kw">fit.ols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({<span class="fu"><a href="https://rdrr.io/pkg/R.utils/man/withTimeout.html">withTimeout</a></span>({<span class="fu"><a href="../reference/NILE.html">NILE</a></span>(Y=<span class="kw">Y</span>,X=<span class="kw">X</span>,A=<span class="kw">A</span>,lambda.star=<span class="fl">0</span>,df=<span class="kw">df.X</span>,x.new=<span class="kw">x.new</span>,plot=<span class="fl">FALSE</span>,par.a=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(lambda=<span class="fl">0.1</span>))<span class="op">$</span><span class="kw">pred</span>}, timeout = <span class="fl">180</span>, onTimeout = <span class="st">"error"</span>)},
                      error=<span class="fu">function</span>(<span class="kw">e</span>){
                        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ERROR OLS: "</span>, <span class="kw">e</span>))
                        <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>))
                      })

  <span class="kw">nile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({<span class="fu"><a href="https://rdrr.io/pkg/R.utils/man/withTimeout.html">withTimeout</a></span>({<span class="fu"><a href="../reference/NILE.html">NILE</a></span>(Y=<span class="kw">Y</span>,X=<span class="kw">X</span>,A=<span class="kw">A</span>,lambda.star=<span class="st">"test"</span>,df=<span class="kw">df.X</span>,x.new=<span class="kw">x.new</span>,plot=<span class="fl">FALSE</span>)}, timeout = <span class="fl">180</span>, onTimeout = <span class="st">"error"</span>)},
                   error=<span class="fu">function</span>(<span class="kw">e</span>){
                     <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ERROR NILE: "</span>, <span class="kw">e</span>))
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(pred = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)), lambda.star = <span class="fl">NA</span>)
                   })
  <span class="kw">fit.nile</span> <span class="op">&lt;-</span> <span class="kw">nile</span><span class="op">$</span><span class="kw">pred</span>
  <span class="kw">lambda.star</span> <span class="op">&lt;-</span> <span class="kw">nile</span><span class="op">$</span><span class="kw">lambda.star</span>

  <span class="kw">fit.npregiv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({<span class="fu"><a href="https://rdrr.io/pkg/R.utils/man/withTimeout.html">withTimeout</a></span>({<span class="fu">npregiv</span>(y=<span class="kw">Y</span>,z=<span class="kw">X</span>,w=<span class="kw">A</span>,zeval=<span class="kw">x.new</span>)<span class="op">$</span><span class="kw">phi.eval</span>}, timeout = <span class="fl">180</span>, onTimeout = <span class="st">"error"</span>)},
                          error=<span class="fu">function</span>(<span class="kw">e</span>){
                            <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ERROR NPREGIV: "</span>, <span class="kw">e</span>))
                            <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>))
                          })

  <span class="kw">pred.frame.loop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(x = <span class="kw">x.new</span>,
                                fhat = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">fit.ols</span>, <span class="kw">fit.nile</span>, <span class="kw">fit.npregiv</span>),
                                ftrue = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw">f.new</span>, <span class="fl">3</span>),
                                method = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"OLS"</span>, <span class="st">"NILE"</span>, <span class="st">"NPREGIV"</span>), each = <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)),
                                lambda.star = <span class="kw">lambda.star</span>,
                                alphaA = <span class="kw">alphaA</span>,
                                alphaH = <span class="kw">alphaH</span>,
                                alphaEps = <span class="kw">alphaEps</span>,
                                qXmin = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">qX</span>),
                                qXmax = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">qX</span>),
                                suppXmin = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">suppX</span>),
                                suppXmax = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">suppX</span>),
                                sim = <span class="kw">i</span>)
  <span class="kw">pred.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">pred.frame</span>, <span class="kw">pred.frame.loop</span>)
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>(<span class="kw">pred.frame</span>, <span class="st">"overlay_estimates_strongconf.txt"</span>, quote = <span class="fl">FALSE</span>)
}
</pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">reshape2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">gridExtra</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/HenrikBengtsson/R.utils">R.utils</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">splines</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">np</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>())
<span class="kw">pred.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"overlay_estimates_strongconf.txt"</span>, header = <span class="fl">TRUE</span>)

<span class="kw">fact</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># three times the desired variance of X</span>
<span class="co">## missing settings</span>
<span class="kw">alphaA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>)
<span class="kw">alphaH</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">2</span><span class="op">/</span><span class="fl">3</span>)
<span class="kw">alphaEps</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="co">## quantiles for different settings</span>
<span class="kw">qX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">qXmin</span>[<span class="fl">1</span>], <span class="kw">pred.frame</span><span class="op">$</span><span class="kw">qXmax</span>[<span class="fl">1</span>])
<span class="kw">suppX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">suppXmin</span>[<span class="fl">1</span>], <span class="kw">pred.frame</span><span class="op">$</span><span class="kw">suppXmax</span>[<span class="fl">1</span>])

<span class="kw">n.splines.true</span> <span class="op">&lt;-</span> <span class="fl">4</span>
<span class="kw">fX</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">x</span>=<span class="kw">x.new</span>, <span class="kw">qx</span>=<span class="kw">qX</span>, <span class="kw">beta</span>=<span class="kw">beta</span>){
  <span class="kw">bx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html">ns</a></span>(<span class="kw">x</span>, knots = <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(from=<span class="kw">qx</span>[<span class="fl">1</span>], to=<span class="kw">qx</span>[<span class="fl">2</span>], length.out=(<span class="kw">n.splines.true</span><span class="op">+</span><span class="fl">1</span>))[<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="kw">n.splines.true</span><span class="op">+</span><span class="fl">1</span>)], Boundary.knots = <span class="kw">qx</span>)
  <span class="kw">bx</span><span class="op">%*%</span><span class="kw">beta</span>
}

<span class="kw">n.plt</span> <span class="op">&lt;-</span> <span class="fl">200</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">4</span>)
<span class="kw">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n.splines.true</span>, <span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">A1.plt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n.plt</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">H1.plt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n.plt</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">X1.plt</span> <span class="op">&lt;-</span> <span class="kw">alphaA</span><span class="op">*</span><span class="kw">A1.plt</span> <span class="op">+</span> <span class="kw">alphaH</span><span class="op">*</span><span class="kw">H1.plt</span> <span class="op">+</span> <span class="kw">alphaEps</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n.plt</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">Y1.plt</span> <span class="op">&lt;-</span> <span class="fu">fX</span>(<span class="kw">X1.plt</span>,<span class="kw">qX</span>,<span class="kw">beta</span>) <span class="op">+</span> <span class="fl">.3</span><span class="op">*</span><span class="kw">H1.plt</span> <span class="op">+</span> <span class="fl">.2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n.plt</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)

<span class="kw">plt.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(x=<span class="kw">X1.plt</span>, y=<span class="kw">Y1.plt</span>)
<span class="co"># ftrue.frame &lt;- data.frame(x=x.pred, ftrue=f.true)</span>

<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">method</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">method</span>, levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"OLS"</span>, <span class="st">"NILE"</span>, <span class="st">"NPREGIV"</span>))

<span class="kw">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">pred.frame</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(data=<span class="kw">plt.frame</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span>,<span class="kw">y</span>), alpha=<span class="fl">.5</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(xintercept = <span class="kw">qX</span>, lty = <span class="fl">2</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span>, <span class="kw">fhat</span>, col = <span class="kw">method</span>, group = <span class="kw">sim</span>), size = <span class="fl">.2</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span>, <span class="kw">ftrue</span>), col = <span class="st">"#009E73"</span>, size=<span class="fl">1</span>, lty = <span class="st">"dashed"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#D55E00"</span>,<span class="st">"#0072B2"</span>, <span class="st">"#CC79A7"</span>)) <span class="op">+</span>
  <span class="co"># ggtitle("")</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="kw">.</span><span class="op">~</span><span class="kw">method</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span>(xlim=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">2</span>,<span class="fl">2</span>), ylim = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(legend.position = <span class="st">"none"</span>)
<span class="kw">p</span>


<span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html">pdf</a></span>(<span class="st">"overlay_estimates.pdf"</span>, width = <span class="fl">7</span>, height = <span class="fl">2.5</span>)
<span class="kw">p</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span>()
</pre></div>
</div>
<div id="figure-3---varying-confounding" class="section level2">
<h2 class="hasAnchor">
<a href="#figure-3---varying-confounding" class="anchor"></a>Figure 3 - Varying confounding</h2>
<p>This experiment is computationally intensive, therefore it is advisable to run it in parallel. The number of simulations is 100, so one strategy is to run it in chunks of 10 simulations at a time.</p>
<p>For example, the first chunk of simulations can be run as follows.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">SIM</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>
</pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/runesen/NILE">NILE</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/HenrikBengtsson/R.utils">R.utils</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">splines</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">np</span>)
<span class="co"># X has fixed variance 1/3</span>
<span class="kw">n</span> <span class="op">&lt;-</span> <span class="fl">200</span>
<span class="kw">fact</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># three times the desired variance of X</span>
<span class="kw">df.X</span> <span class="op">&lt;-</span> <span class="fl">50</span> <span class="co"># number of splines used</span>
<span class="co">## missing settings</span>
<span class="kw">alphaA.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="kw">fact</span><span class="op">/</span><span class="fl">3</span>),<span class="fl">3</span>)
<span class="kw">alphaH.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="kw">fact</span><span class="op">/</span><span class="fl">3</span>),<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">2</span><span class="op">*</span><span class="kw">fact</span><span class="op">/</span><span class="fl">3</span>))
<span class="kw">alphaEps.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="kw">fact</span> <span class="op">-</span> <span class="kw">alphaA.seq</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="kw">alphaH.seq</span><span class="op">^</span><span class="fl">2</span>)
<span class="co">## check</span>
<span class="kw">alphaA.seq</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="kw">alphaH.seq</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="kw">alphaEps.seq</span><span class="op">^</span><span class="fl">2</span>
<span class="co">## quantiles for different settings</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)
<span class="kw">n.exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">alphaA.seq</span>)
<span class="kw">qX.mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span><span class="op">:</span><span class="kw">n.exp</span>, <span class="fu">function</span>(<span class="kw">i</span>){
  <span class="kw">N</span> <span class="op">&lt;-</span> <span class="fl">100000</span>
  <span class="kw">alphaA</span> <span class="op">&lt;-</span> <span class="kw">alphaA.seq</span>[<span class="kw">i</span>]
  <span class="kw">alphaH</span> <span class="op">&lt;-</span> <span class="kw">alphaH.seq</span>[<span class="kw">i</span>]
  <span class="kw">alphaEps</span> <span class="op">&lt;-</span> <span class="kw">alphaEps.seq</span>[<span class="kw">i</span>]
  <span class="kw">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
  <span class="kw">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
  <span class="kw">X</span> <span class="op">&lt;-</span> <span class="kw">alphaA</span><span class="op">*</span><span class="kw">A</span> <span class="op">+</span> <span class="kw">alphaH</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="kw">alphaEps</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
  <span class="kw">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="kw">X</span>, probs = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.05</span>,<span class="fl">.95</span>))
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)<span class="op">*</span>(<span class="kw">q</span>[<span class="fl">2</span>]<span class="op">-</span><span class="kw">q</span>[<span class="fl">1</span>])<span class="op">/</span><span class="fl">2</span>
})
<span class="kw">suppX.mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span><span class="op">:</span><span class="kw">n.exp</span>, <span class="fu">function</span>(<span class="kw">i</span>){
  <span class="kw">alphaA</span> <span class="op">&lt;-</span> <span class="kw">alphaA.seq</span>[<span class="kw">i</span>]
  <span class="kw">alphaH</span> <span class="op">&lt;-</span> <span class="kw">alphaH.seq</span>[<span class="kw">i</span>]
  <span class="kw">alphaEps</span> <span class="op">&lt;-</span> <span class="kw">alphaEps.seq</span>[<span class="kw">i</span>]
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)<span class="op">*</span>(<span class="kw">alphaA</span> <span class="op">+</span> <span class="kw">alphaH</span> <span class="op">+</span> <span class="kw">alphaEps</span>)
})

<span class="kw">n.splines.true</span> <span class="op">&lt;-</span> <span class="fl">4</span>
<span class="kw">fX</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">x</span>, <span class="kw">qx</span>, <span class="kw">beta</span>){
  <span class="kw">bx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html">ns</a></span>(<span class="kw">x</span>, knots = <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(from=<span class="kw">qx</span>[<span class="fl">1</span>], to=<span class="kw">qx</span>[<span class="fl">2</span>], length.out=(<span class="kw">n.splines.true</span><span class="op">+</span><span class="fl">1</span>))[<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="kw">n.splines.true</span><span class="op">+</span><span class="fl">1</span>)], Boundary.knots = <span class="kw">qx</span>)
  <span class="kw">bx</span><span class="op">%*%</span><span class="kw">beta</span>
}

<span class="kw">pred.frame</span> <span class="op">&lt;-</span> <span class="kw">NULL</span>
<span class="kw">meta.frame</span> <span class="op">&lt;-</span> <span class="kw">NULL</span>
<span class="kw">x.new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="fl">2</span>,<span class="fl">2</span>,length.out = <span class="fl">100</span>)
<span class="kw">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">SIM</span>)<span class="op">*</span><span class="kw">n.exp</span>
<span class="co">for</span>(<span class="kw">i</span> <span class="co">in</span> <span class="kw">SIM</span>){
  <span class="co">for</span>(<span class="kw">j</span> <span class="co">in</span> <span class="fl">1</span><span class="op">:</span><span class="kw">n.exp</span>){
    <span class="kw">k</span> <span class="op">&lt;-</span> <span class="kw">k</span><span class="op">+</span><span class="fl">1</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="kw">k</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"sim = "</span>, <span class="kw">i</span>, <span class="st">", alphaseq = "</span>, <span class="kw">j</span>))
    <span class="kw">alphaA</span> <span class="op">&lt;-</span> <span class="kw">alphaA.seq</span>[<span class="kw">j</span>]
    <span class="kw">alphaEps</span> <span class="op">&lt;-</span> <span class="kw">alphaEps.seq</span>[<span class="kw">j</span>]
    <span class="kw">alphaH</span> <span class="op">&lt;-</span> <span class="kw">alphaH.seq</span>[<span class="kw">j</span>]
    <span class="kw">qX</span> <span class="op">&lt;-</span> <span class="kw">qX.mat</span>[,<span class="kw">j</span>]
    <span class="kw">suppX</span> <span class="op">&lt;-</span> <span class="kw">suppX.mat</span>[,<span class="kw">j</span>]

    <span class="kw">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n.splines.true</span>, <span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">X</span> <span class="op">&lt;-</span> <span class="kw">alphaA</span><span class="op">*</span><span class="kw">A</span> <span class="op">+</span> <span class="kw">alphaH</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="kw">alphaEps</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">Y</span> <span class="op">&lt;-</span> <span class="fu">fX</span>(<span class="kw">X</span>,<span class="kw">qX</span>,<span class="kw">beta</span>) <span class="op">+</span> <span class="fl">.3</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="fl">.2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">f.new</span> <span class="op">&lt;-</span> <span class="fu">fX</span>(<span class="kw">x.new</span>,<span class="kw">qX</span>,<span class="kw">beta</span>)

    <span class="kw">ols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({
      <span class="kw">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
      <span class="kw">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R.utils/man/withTimeout.html">withTimeout</a></span>({<span class="fu"><a href="../reference/NILE.html">NILE</a></span>(Y=<span class="kw">Y</span>,X=<span class="kw">X</span>,A=<span class="kw">A</span>,lambda.star=<span class="fl">0</span>,df=<span class="kw">df.X</span>,x.new=<span class="kw">x.new</span>,plot=<span class="fl">FALSE</span>,par.a=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(lambda=<span class="fl">0.1</span>))}, timeout = <span class="fl">180</span>, onTimeout = <span class="st">"silent"</span>)
      <span class="kw">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
      <span class="co">if</span>(<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">res</span>)){
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">t2</span><span class="op">-</span><span class="kw">t1</span>),
             fit = <span class="kw">res</span><span class="op">$</span><span class="kw">pred</span>,
             timeout = <span class="fl">FALSE</span>,
             error = <span class="fl">FALSE</span>)
      }
      <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">res</span>)){
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fl">180</span>,
             fit = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)),
             timeout = <span class="fl">TRUE</span>,
             error = <span class="fl">FALSE</span>)
      }
      <span class="kw">out</span>
    },
    error=<span class="fu">function</span>(<span class="kw">e</span>){
      <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ERROR OLS: "</span>, <span class="kw">e</span>))
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fl">NA</span>, fit = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)), timeout = <span class="fl">NA</span>, error = <span class="fl">TRUE</span>)
    })

    <span class="kw">nile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({
      <span class="kw">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
      <span class="kw">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R.utils/man/withTimeout.html">withTimeout</a></span>({<span class="fu"><a href="../reference/NILE.html">NILE</a></span>(Y=<span class="kw">Y</span>,X=<span class="kw">X</span>,A=<span class="kw">A</span>,lambda.star=<span class="st">"test"</span>,df=<span class="kw">df.X</span>,x.new=<span class="kw">x.new</span>,plot=<span class="fl">FALSE</span>)}, timeout = <span class="fl">180</span>, onTimeout = <span class="st">"silent"</span>)
      <span class="kw">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
      <span class="co">if</span>(<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">res</span>)){
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">t2</span><span class="op">-</span><span class="kw">t1</span>),
             lambda = <span class="kw">res</span><span class="op">$</span><span class="kw">lambda.star</span>,
             fit = <span class="kw">res</span><span class="op">$</span><span class="kw">pred</span>,
             timeout = <span class="fl">FALSE</span>,
             error = <span class="fl">FALSE</span>)
      }
      <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">res</span>)){
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fl">180</span>,
             lambda = <span class="fl">NA</span>,
             fit = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)),
             timeout = <span class="fl">TRUE</span>,
             error = <span class="fl">FALSE</span>)
      }
      <span class="kw">out</span>
    },
    error=<span class="fu">function</span>(<span class="kw">e</span>){
      <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ERROR NILE: "</span>, <span class="kw">e</span>))
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fl">NA</span>, lambda = <span class="fl">NA</span>, fit = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)), timeout = <span class="fl">NA</span>, error = <span class="fl">TRUE</span>)
    })

    <span class="kw">npregiv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({
      <span class="kw">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
      <span class="kw">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R.utils/man/withTimeout.html">withTimeout</a></span>({<span class="fu">npregiv</span>(y=<span class="kw">Y</span>,z=<span class="kw">X</span>,w=<span class="kw">A</span>,zeval=<span class="kw">x.new</span>)}, timeout = <span class="fl">180</span>, onTimeout = <span class="st">"silent"</span>)
      <span class="kw">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
      <span class="co">if</span>(<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">res</span>)){
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">t2</span><span class="op">-</span><span class="kw">t1</span>),
             fit = <span class="kw">res</span><span class="op">$</span><span class="kw">phi.eval</span>,
             timeout = <span class="fl">FALSE</span>,
             error = <span class="fl">FALSE</span>)
      }
      <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">res</span>)){
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fl">180</span>,
             fit = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)),
             timeout = <span class="fl">TRUE</span>,
             error = <span class="fl">FALSE</span>)
      }
      <span class="kw">out</span>
    },
    error=<span class="fu">function</span>(<span class="kw">e</span>){
      <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ERROR OLS: "</span>, <span class="kw">e</span>))
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fl">NA</span>, fit = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)), timeout = <span class="fl">NA</span>, error = <span class="fl">TRUE</span>)
    })

    <span class="kw">meta.frame.loop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(method = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"OLS"</span>, <span class="st">"NILE"</span>, <span class="st">"NPREGIV"</span>),
                                  time = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">ols</span><span class="op">$</span><span class="kw">time</span>, <span class="kw">nile</span><span class="op">$</span><span class="kw">time</span>, <span class="kw">npregiv</span><span class="op">$</span><span class="kw">time</span>),
                                  timeout = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">ols</span><span class="op">$</span><span class="kw">timeout</span>, <span class="kw">nile</span><span class="op">$</span><span class="kw">timeout</span>, <span class="kw">npregiv</span><span class="op">$</span><span class="kw">timeout</span>),
                                  error = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">ols</span><span class="op">$</span><span class="kw">error</span>, <span class="kw">nile</span><span class="op">$</span><span class="kw">error</span>, <span class="kw">npregiv</span><span class="op">$</span><span class="kw">error</span>),
                                  lambda.star = <span class="kw">nile</span><span class="op">$</span><span class="kw">lambda</span>,
                                  alphaA = <span class="kw">alphaA</span>,
                                  alphaH = <span class="kw">alphaH</span>,
                                  alphaEps = <span class="kw">alphaEps</span>,
                                  qXmin = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">qX</span>),
                                  qXmax = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">qX</span>),
                                  suppXmin = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">suppX</span>),
                                  suppXmax = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">suppX</span>),
                                  experiment = <span class="kw">j</span>,
                                  sim = <span class="kw">i</span>)
    <span class="kw">meta.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">meta.frame</span>, <span class="kw">meta.frame.loop</span>)

    <span class="kw">pred.frame.loop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(x = <span class="kw">x.new</span>,
                                  fhat = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">ols</span><span class="op">$</span><span class="kw">fit</span>, <span class="kw">nile</span><span class="op">$</span><span class="kw">fit</span>, <span class="kw">npregiv</span><span class="op">$</span><span class="kw">fit</span>),
                                  ftrue = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw">f.new</span>, <span class="fl">3</span>),
                                  method = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"OLS"</span>, <span class="st">"NILE"</span>, <span class="st">"NPREGIV"</span>), each = <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)),
                                  lambda.star = <span class="kw">nile</span><span class="op">$</span><span class="kw">lambda</span>,
                                  alphaA = <span class="kw">alphaA</span>,
                                  alphaH = <span class="kw">alphaH</span>,
                                  alphaEps = <span class="kw">alphaEps</span>,
                                  qXmin = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">qX</span>),
                                  qXmax = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">qX</span>),
                                  suppXmin = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">suppX</span>),
                                  suppXmax = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">suppX</span>),
                                  experiment = <span class="kw">j</span>,
                                  sim = <span class="kw">i</span>)
    <span class="kw">pred.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">pred.frame</span>, <span class="kw">pred.frame.loop</span>)

    <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>(<span class="kw">meta.frame</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"varying_confounding_meta"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">SIM</span>), <span class="st">".txt"</span>), quote = <span class="fl">FALSE</span>)
    <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>(<span class="kw">pred.frame</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"varying_confounding_fit"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">SIM</span>), <span class="st">".txt"</span>), quote = <span class="fl">FALSE</span>)
  }
}
</pre></div>
<p>Once the results are saved as <code>.txt</code> files, you can produce the plots as follows.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">reshape2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">gridExtra</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>())
<span class="kw">pred.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_confounding_fit1.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_confounding_fit11.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_confounding_fit21.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_confounding_fit31.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_confounding_fit41.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_confounding_fit51.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_confounding_fit61.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_confounding_fit71.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_confounding_fit81.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_confounding_fit91.txt"</span>, header = <span class="fl">TRUE</span>))

<span class="co">## avg lambdastar</span>
<span class="kw">df.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(<span class="kw">lambda.star</span> <span class="op">~</span> <span class="kw">experiment</span>, <span class="kw">pred.frame</span>, <span class="kw">mean</span>, na.rm=<span class="fl">1</span>)
<span class="co">##</span>
<span class="kw">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">pred.frame</span>)
<span class="kw">n.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">x</span>))
<span class="kw">n.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">method</span>))
<span class="kw">n.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">sim</span>))
<span class="kw">n.exp</span> <span class="op">&lt;-</span> <span class="kw">n</span><span class="op">/</span>(<span class="kw">n.x</span><span class="op">*</span><span class="kw">n.m</span><span class="op">*</span><span class="kw">n.sim</span>)

<span class="kw">var_xi_Y</span> <span class="op">&lt;-</span> (<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>)<span class="op">*</span>(<span class="fl">.3</span><span class="op">^</span><span class="fl">2</span><span class="op">+</span><span class="fl">.2</span><span class="op">^</span><span class="fl">2</span>)

<span class="co"># pred.frame &lt;- subset(pred.frame, method != "IV")</span>
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">sq.err</span> <span class="op">&lt;-</span> (<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">fhat</span><span class="op">-</span><span class="kw">pred.frame</span><span class="op">$</span><span class="kw">ftrue</span>)<span class="op">^</span><span class="fl">2</span>
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">x.abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">x</span>),<span class="fl">2</span>)
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">alphaA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">alphaA</span>,<span class="fl">3</span>)
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">alphaH</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">alphaH</span>,<span class="fl">3</span>)
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">alphaEps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">alphaEps</span>,<span class="fl">3</span>)
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">qXmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">qXmax</span>,<span class="fl">3</span>)
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">lambda.star</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">lambda.star</span>,<span class="fl">3</span>)
<span class="kw">error.frame.x.abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(<span class="kw">sq.err</span> <span class="op">~</span> <span class="kw">method</span> <span class="op">+</span> <span class="kw">alphaH</span> <span class="op">+</span> <span class="kw">qXmax</span> <span class="op">+</span> <span class="kw">x.abs</span> <span class="op">+</span> <span class="kw">sim</span>, <span class="kw">pred.frame</span>, <span class="kw">mean</span>)
<span class="kw">error.frame.x.abs</span> <span class="op">&lt;-</span> <span class="kw">error.frame.x.abs</span>[<span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">method</span>, <span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">alphaH</span>, <span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">sim</span>),]
<span class="kw">n.x.abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">x.abs</span>))
<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">worst.case.mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">error.frame.x.abs</span>), <span class="fu">function</span>(<span class="kw">i</span>) <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">sq.err</span>[(<span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span>((<span class="kw">i</span><span class="op">-</span><span class="fl">1</span>)<span class="op">/</span><span class="kw">n.x.abs</span>)<span class="op">*</span><span class="kw">n.x.abs</span>)<span class="op">:</span><span class="kw">i</span>])) <span class="op">+</span> <span class="kw">var_xi_Y</span>
<span class="co"># error.frame.x.abs$method &lt;- factor(error.frame.x.abs$method,</span>
<span class="co">#                                    levels = c("OLS", "NILE", "NPREGIV", "ORACLE"))</span>
<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">alphaH</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">alphaH</span>,
                                       levels = <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">alphaH</span>)),
                                       labels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"("</span>, <span class="kw">alpha</span>[<span class="kw">A</span>], <span class="st">","</span>, <span class="kw">alpha</span>[<span class="kw">H</span>], <span class="st">","</span>, <span class="kw">alpha</span>[<span class="kw">epsilon</span>], <span class="st">")  =  ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>),<span class="st">","</span>, <span class="fl">0</span>,<span class="st">","</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">2</span><span class="op">/</span><span class="fl">3</span>), <span class="st">")"</span>)),
                                                  <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"("</span>, <span class="kw">alpha</span>[<span class="kw">A</span>],<span class="st">","</span>, <span class="kw">alpha</span>[<span class="kw">H</span>],<span class="st">","</span>, <span class="kw">alpha</span>[<span class="kw">epsilon</span>], <span class="st">")  =  ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>),<span class="st">","</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>),<span class="st">","</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>), <span class="st">")"</span>)),
                                                  <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"("</span>, <span class="kw">alpha</span>[<span class="kw">A</span>], <span class="st">","</span>,<span class="kw">alpha</span>[<span class="kw">H</span>],<span class="st">","</span>, <span class="kw">alpha</span>[<span class="kw">epsilon</span>], <span class="st">")  =  ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>),<span class="st">","</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">2</span><span class="op">/</span><span class="fl">3</span>),<span class="st">","</span>, <span class="fl">0</span>, <span class="st">")"</span>))))

<span class="kw">error.frame.x.abs.avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(<span class="kw">worst.case.mse</span> <span class="op">~</span> <span class="kw">method</span> <span class="op">+</span> <span class="kw">alphaH</span> <span class="op">+</span> <span class="kw">qXmax</span> <span class="op">+</span> <span class="kw">x.abs</span>, <span class="kw">error.frame.x.abs</span>, <span class="kw">mean</span>)
<span class="kw">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">error.frame.x.abs.avg</span>, <span class="kw">method</span> <span class="op">==</span> <span class="st">"OLS"</span>)
<span class="kw">tmp</span><span class="op">$</span><span class="kw">worst.case.mse</span> <span class="op">&lt;-</span> <span class="kw">var_xi_Y</span>
<span class="kw">tmp</span><span class="op">$</span><span class="kw">method</span> <span class="op">&lt;-</span> <span class="st">"ORACLE"</span>
<span class="kw">error.frame.x.abs.avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">error.frame.x.abs.avg</span>, <span class="kw">tmp</span>)

<span class="kw">error.frame.x.abs.avg</span><span class="op">$</span><span class="kw">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">sim</span><span class="op">+</span><span class="fl">1</span>)
<span class="kw">error.frame.x.abs.avg</span><span class="op">$</span><span class="kw">sq.err</span> <span class="op">&lt;-</span> <span class="fl">NA</span>
<span class="kw">error.frame.x.abs.avg</span><span class="op">$</span><span class="kw">avg</span> <span class="op">&lt;-</span> <span class="fl">TRUE</span>
<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">avg</span> <span class="op">&lt;-</span> <span class="fl">FALSE</span>
<span class="kw">error.frame.x.abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">error.frame.x.abs</span>, <span class="kw">error.frame.x.abs.avg</span>)

<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">method</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">method</span>,
                                   levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"OLS"</span>, <span class="st">"NILE"</span>, <span class="st">"NPREGIV"</span>, <span class="st">"ORACLE"</span>))

<span class="kw">qX.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">error.frame.x.abs.avg</span>, <span class="kw">method</span> <span class="op">==</span> <span class="st">"OLS"</span> <span class="op">&amp;</span> <span class="kw">x.abs</span> <span class="op">==</span> <span class="fl">2</span>)
<span class="kw">rects1</span> <span class="op">&lt;-</span> <span class="kw">qX.frame</span>
<span class="kw">rects1</span><span class="op">$</span><span class="kw">xstart</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="kw">rects1</span><span class="op">$</span><span class="kw">xend</span> <span class="op">&lt;-</span> <span class="kw">rects1</span><span class="op">$</span><span class="kw">qXmax</span>
<span class="kw">rects2</span> <span class="op">&lt;-</span> <span class="kw">qX.frame</span>
<span class="kw">rects2</span><span class="op">$</span><span class="kw">xstart</span> <span class="op">&lt;-</span> <span class="kw">rects2</span><span class="op">$</span><span class="kw">qXmax</span>
<span class="kw">rects2</span><span class="op">$</span><span class="kw">xend</span> <span class="op">&lt;-</span> <span class="fl">2</span>
<span class="kw">rects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">rects1</span>, <span class="kw">rects2</span>)
<span class="kw">rects</span><span class="op">$</span><span class="kw">col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, each=<span class="kw">n.exp</span>))

<span class="co">#############</span>
<span class="co">## plotting</span>
<span class="co">#############</span>

<span class="kw">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() <span class="op">+</span>
  <span class="co"># geom_density(data=df.plt, aes(x=x.plt),alpha=.5) +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_rect</a></span>(data = <span class="kw">rects</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(xmin = <span class="kw">xstart</span>, xmax = <span class="kw">xend</span>, ymin = <span class="op">-</span><span class="fl">Inf</span>, ymax = <span class="fl">Inf</span>, fill=<span class="kw">col</span>), alpha=<span class="fl">.1</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(data=<span class="kw">error.frame.x.abs</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x.abs</span>, <span class="kw">worst.case.mse</span>, col=<span class="kw">method</span>, lty = <span class="kw">method</span>, group = <span class="fu"><a href="https://rdrr.io/r/base/interaction.html">interaction</a></span>(<span class="kw">method</span>,<span class="kw">sim</span>,<span class="kw">avg</span>), alpha=<span class="kw">avg</span>, size = <span class="kw">avg</span>)) <span class="op">+</span>
  <span class="co">#geom_line(data=error.frame.x.abs.avg, aes(x.abs, worst.case.mse, col=method, lty = method), size=1) +</span>
  <span class="co"># facet_wrap(. ~ alphaA + alphaH + alphaEps, ncol=5) +</span>
  <span class="co"># geom_vline(aes(xintercept = qXmax),lty=2) +</span>
  <span class="co"># geom_hline(yintercept = var_xi_Y,lty=2, col = "black") +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="kw">.</span> <span class="op">~</span> <span class="kw">alphaH</span>, labeller = <span class="kw">label_parsed</span>) <span class="op">+</span>
  <span class="co"># ggtitle(expression(paste("constant instrument strength alpha_A = ", 1/sqrt(3)))) +</span>
  <span class="co"># ggtitle(expression(paste("constant instrument strength ", alpha[A], " = ", sqrt(1/3)))) +</span>
  <span class="co"># gtitle("generalization performance for different confounding strength") +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_size_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.2</span>, <span class="fl">1</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_alpha_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.2</span>, <span class="fl">1</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#D55E00"</span>,
                                <span class="co">#"#0072B2",</span>
                                <span class="st">"#0072B2"</span>, <span class="st">"#CC79A7"</span>, <span class="st">"#009E73"</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_linetype_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"solid"</span>,<span class="fl">3</span>), <span class="st">"dashed"</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"black"</span>, <span class="st">"transparent"</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span>(xlim = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">2</span>), ylim = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">.3</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"generalization to interventions up to strength"</span>) <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"worst-case MSE"</span>)  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(plot.title = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(hjust=<span class="fl">0.5</span>),
        <span class="co">#legend.position = "none",</span>
        legend.background = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span>(fill = <span class="st">"transparent"</span>, colour = <span class="fl">NA</span>),
        legend.key = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span>(fill = <span class="st">"transparent"</span>, colour = <span class="fl">NA</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span>(fill=<span class="st">"none"</span>, lty= <span class="st">"none"</span>, size = <span class="st">"none"</span>, alpha = <span class="st">"none"</span>)
<span class="kw">p</span>


<span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html">pdf</a></span>(<span class="st">"varying_confounding_with_variability.pdf"</span>, width = <span class="fl">8</span>, height = <span class="fl">2.5</span>)
<span class="kw">p</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span>()
</pre></div>
</div>
<div id="figure-4---varying-instrument" class="section level2">
<h2 class="hasAnchor">
<a href="#figure-4---varying-instrument" class="anchor"></a>Figure 4 - Varying instrument</h2>
<p>This experiment is computationally intensive, therefore it is advisable to run it in parallel. The number of simulations is 100, so one strategy is to run it in chunks of 10 simulations at a time.</p>
<p>For example, the first chunk of simulations can be run as follows.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw">SIM</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>
</pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/runesen/NILE">NILE</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/HenrikBengtsson/R.utils">R.utils</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">splines</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">np</span>)
<span class="co"># X has fixed variance 1/3</span>
<span class="kw">n</span> <span class="op">&lt;-</span> <span class="fl">200</span>
<span class="kw">fact</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># three times the desired variance of X</span>
<span class="kw">df.X</span> <span class="op">&lt;-</span> <span class="fl">50</span>
<span class="co">## missing settings</span>
<span class="kw">alphaA.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>,<span class="fl">2</span><span class="op">/</span><span class="fl">3</span>,length.out=<span class="fl">5</span>))
<span class="kw">alphaH.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="kw">fact</span><span class="op">/</span><span class="fl">3</span>),<span class="fl">5</span>)
<span class="kw">alphaEps.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="kw">fact</span> <span class="op">-</span> <span class="kw">alphaA.seq</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="kw">alphaH.seq</span><span class="op">^</span><span class="fl">2</span>)
<span class="co">## check</span>
<span class="kw">alphaA.seq</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="kw">alphaH.seq</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="kw">alphaEps.seq</span><span class="op">^</span><span class="fl">2</span>
<span class="co">## quantiles for different settings</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)
<span class="kw">n.exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">alphaA.seq</span>)
<span class="kw">qX.mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span><span class="op">:</span><span class="kw">n.exp</span>, <span class="fu">function</span>(<span class="kw">i</span>){
  <span class="kw">N</span> <span class="op">&lt;-</span> <span class="fl">100000</span>
  <span class="kw">alphaA</span> <span class="op">&lt;-</span> <span class="kw">alphaA.seq</span>[<span class="kw">i</span>]
  <span class="kw">alphaH</span> <span class="op">&lt;-</span> <span class="kw">alphaH.seq</span>[<span class="kw">i</span>]
  <span class="kw">alphaEps</span> <span class="op">&lt;-</span> <span class="kw">alphaEps.seq</span>[<span class="kw">i</span>]
  <span class="kw">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
  <span class="kw">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
  <span class="kw">X</span> <span class="op">&lt;-</span> <span class="kw">alphaA</span><span class="op">*</span><span class="kw">A</span> <span class="op">+</span> <span class="kw">alphaH</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="kw">alphaEps</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
  <span class="kw">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="kw">X</span>, probs = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.05</span>,<span class="fl">.95</span>))
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)<span class="op">*</span>(<span class="kw">q</span>[<span class="fl">2</span>]<span class="op">-</span><span class="kw">q</span>[<span class="fl">1</span>])<span class="op">/</span><span class="fl">2</span>
})
<span class="kw">suppX.mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span><span class="op">:</span><span class="kw">n.exp</span>, <span class="fu">function</span>(<span class="kw">i</span>){
  <span class="kw">alphaA</span> <span class="op">&lt;-</span> <span class="kw">alphaA.seq</span>[<span class="kw">i</span>]
  <span class="kw">alphaH</span> <span class="op">&lt;-</span> <span class="kw">alphaH.seq</span>[<span class="kw">i</span>]
  <span class="kw">alphaEps</span> <span class="op">&lt;-</span> <span class="kw">alphaEps.seq</span>[<span class="kw">i</span>]
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)<span class="op">*</span>(<span class="kw">alphaA</span> <span class="op">+</span> <span class="kw">alphaH</span> <span class="op">+</span> <span class="kw">alphaEps</span>)
})

<span class="kw">n.splines.true</span> <span class="op">&lt;-</span> <span class="fl">4</span>
<span class="kw">fX</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">x</span>, <span class="kw">qx</span>, <span class="kw">beta</span>){
  <span class="kw">bx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html">ns</a></span>(<span class="kw">x</span>, knots = <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(from=<span class="kw">qx</span>[<span class="fl">1</span>], to=<span class="kw">qx</span>[<span class="fl">2</span>], length.out=(<span class="kw">n.splines.true</span><span class="op">+</span><span class="fl">1</span>))[<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="kw">n.splines.true</span><span class="op">+</span><span class="fl">1</span>)], Boundary.knots = <span class="kw">qx</span>)
  <span class="kw">bx</span><span class="op">%*%</span><span class="kw">beta</span>
}

<span class="kw">pred.frame</span> <span class="op">&lt;-</span> <span class="kw">NULL</span>
<span class="kw">meta.frame</span> <span class="op">&lt;-</span> <span class="kw">NULL</span>
<span class="kw">x.new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="fl">2</span>,<span class="fl">2</span>,length.out = <span class="fl">100</span>)
<span class="kw">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">SIM</span>)<span class="op">*</span><span class="kw">n.exp</span>
<span class="co">for</span>(<span class="kw">i</span> <span class="co">in</span> <span class="kw">SIM</span>){
  <span class="co">for</span>(<span class="kw">j</span> <span class="co">in</span> <span class="fl">1</span><span class="op">:</span><span class="kw">n.exp</span>){
    <span class="kw">k</span> <span class="op">&lt;-</span> <span class="kw">k</span><span class="op">+</span><span class="fl">1</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="kw">k</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"sim = "</span>, <span class="kw">i</span>, <span class="st">", alphaseq = "</span>, <span class="kw">j</span>))
    <span class="kw">alphaA</span> <span class="op">&lt;-</span> <span class="kw">alphaA.seq</span>[<span class="kw">j</span>]
    <span class="kw">alphaEps</span> <span class="op">&lt;-</span> <span class="kw">alphaEps.seq</span>[<span class="kw">j</span>]
    <span class="kw">alphaH</span> <span class="op">&lt;-</span> <span class="kw">alphaH.seq</span>[<span class="kw">j</span>]
    <span class="kw">qX</span> <span class="op">&lt;-</span> <span class="kw">qX.mat</span>[,<span class="kw">j</span>]
    <span class="kw">suppX</span> <span class="op">&lt;-</span> <span class="kw">suppX.mat</span>[,<span class="kw">j</span>]

    <span class="kw">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n.splines.true</span>, <span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">X</span> <span class="op">&lt;-</span> <span class="kw">alphaA</span><span class="op">*</span><span class="kw">A</span> <span class="op">+</span> <span class="kw">alphaH</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="kw">alphaEps</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">Y</span> <span class="op">&lt;-</span> <span class="fu">fX</span>(<span class="kw">X</span>,<span class="kw">qX</span>,<span class="kw">beta</span>) <span class="op">+</span> <span class="fl">.3</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="fl">.2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">f.new</span> <span class="op">&lt;-</span> <span class="fu">fX</span>(<span class="kw">x.new</span>,<span class="kw">qX</span>,<span class="kw">beta</span>)

    <span class="kw">ols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({
      <span class="kw">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
      <span class="kw">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R.utils/man/withTimeout.html">withTimeout</a></span>({<span class="fu"><a href="../reference/NILE.html">NILE</a></span>(Y=<span class="kw">Y</span>,X=<span class="kw">X</span>,A=<span class="kw">A</span>,lambda.star=<span class="fl">0</span>,df=<span class="kw">df.X</span>,x.new=<span class="kw">x.new</span>,plot=<span class="fl">FALSE</span>,par.a=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(lambda=<span class="fl">0.1</span>))}, timeout = <span class="fl">180</span>, onTimeout = <span class="st">"silent"</span>)
      <span class="kw">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
      <span class="co">if</span>(<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">res</span>)){
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">t2</span><span class="op">-</span><span class="kw">t1</span>),
                    fit = <span class="kw">res</span><span class="op">$</span><span class="kw">pred</span>,
                    timeout = <span class="fl">FALSE</span>,
                    error = <span class="fl">FALSE</span>)
      }
      <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">res</span>)){
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fl">180</span>,
                    fit = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)),
                    timeout = <span class="fl">TRUE</span>,
                    error = <span class="fl">FALSE</span>)
      }
      <span class="kw">out</span>
    },
    error=<span class="fu">function</span>(<span class="kw">e</span>){
      <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ERROR OLS: "</span>, <span class="kw">e</span>))
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fl">NA</span>, fit = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)), timeout = <span class="fl">NA</span>, error = <span class="fl">TRUE</span>)
    })

    <span class="kw">nile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({
      <span class="kw">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
      <span class="kw">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R.utils/man/withTimeout.html">withTimeout</a></span>({<span class="fu"><a href="../reference/NILE.html">NILE</a></span>(Y=<span class="kw">Y</span>,X=<span class="kw">X</span>,A=<span class="kw">A</span>,lambda.star=<span class="st">"test"</span>,df=<span class="kw">df.X</span>,x.new=<span class="kw">x.new</span>,plot=<span class="fl">FALSE</span>)}, timeout = <span class="fl">180</span>, onTimeout = <span class="st">"silent"</span>)
      <span class="kw">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
      <span class="co">if</span>(<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">res</span>)){
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">t2</span><span class="op">-</span><span class="kw">t1</span>),
                    lambda = <span class="kw">res</span><span class="op">$</span><span class="kw">lambda.star</span>,
                    fit = <span class="kw">res</span><span class="op">$</span><span class="kw">pred</span>,
                    timeout = <span class="fl">FALSE</span>,
                    error = <span class="fl">FALSE</span>)
      }
      <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">res</span>)){
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fl">180</span>,
                    lambda = <span class="fl">NA</span>,
                    fit = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)),
                    timeout = <span class="fl">TRUE</span>,
                    error = <span class="fl">FALSE</span>)
      }
      <span class="kw">out</span>
    },
    error=<span class="fu">function</span>(<span class="kw">e</span>){
      <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ERROR NILE: "</span>, <span class="kw">e</span>))
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fl">NA</span>, lambda = <span class="fl">NA</span>, fit = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)), timeout = <span class="fl">NA</span>, error = <span class="fl">TRUE</span>)
    })

    <span class="kw">npregiv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({
      <span class="kw">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
      <span class="kw">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/R.utils/man/withTimeout.html">withTimeout</a></span>({<span class="fu">npregiv</span>(y=<span class="kw">Y</span>,z=<span class="kw">X</span>,w=<span class="kw">A</span>,zeval=<span class="kw">x.new</span>)}, timeout = <span class="fl">180</span>, onTimeout = <span class="st">"silent"</span>)
      <span class="kw">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
      <span class="co">if</span>(<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">res</span>)){
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">t2</span><span class="op">-</span><span class="kw">t1</span>),
                    fit = <span class="kw">res</span><span class="op">$</span><span class="kw">phi.eval</span>,
                    timeout = <span class="fl">FALSE</span>,
                    error = <span class="fl">FALSE</span>)
      }
      <span class="co">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">res</span>)){
        <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fl">180</span>,
                    fit = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)),
                    timeout = <span class="fl">TRUE</span>,
                    error = <span class="fl">FALSE</span>)
      }
      <span class="kw">out</span>
    },
    error=<span class="fu">function</span>(<span class="kw">e</span>){
      <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ERROR OLS: "</span>, <span class="kw">e</span>))
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(time = <span class="fl">NA</span>, fit = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)), timeout = <span class="fl">NA</span>, error = <span class="fl">TRUE</span>)
    })

    <span class="kw">meta.frame.loop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(method = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"OLS"</span>, <span class="st">"NILE"</span>, <span class="st">"NPREGIV"</span>),
                                  time = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">ols</span><span class="op">$</span><span class="kw">time</span>, <span class="kw">nile</span><span class="op">$</span><span class="kw">time</span>, <span class="kw">npregiv</span><span class="op">$</span><span class="kw">time</span>),
                                  timeout = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">ols</span><span class="op">$</span><span class="kw">timeout</span>, <span class="kw">nile</span><span class="op">$</span><span class="kw">timeout</span>, <span class="kw">npregiv</span><span class="op">$</span><span class="kw">timeout</span>),
                                  error = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">ols</span><span class="op">$</span><span class="kw">error</span>, <span class="kw">nile</span><span class="op">$</span><span class="kw">error</span>, <span class="kw">npregiv</span><span class="op">$</span><span class="kw">error</span>),
                                  lambda.star = <span class="kw">nile</span><span class="op">$</span><span class="kw">lambda</span>,
                                  alphaA = <span class="kw">alphaA</span>,
                                  alphaH = <span class="kw">alphaH</span>,
                                  alphaEps = <span class="kw">alphaEps</span>,
                                  qXmin = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">qX</span>),
                                  qXmax = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">qX</span>),
                                  suppXmin = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">suppX</span>),
                                  suppXmax = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">suppX</span>),
                                  experiment = <span class="kw">j</span>,
                                  sim = <span class="kw">i</span>)
    <span class="kw">meta.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">meta.frame</span>, <span class="kw">meta.frame.loop</span>)

    <span class="kw">pred.frame.loop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(x = <span class="kw">x.new</span>,
                                  fhat = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">ols</span><span class="op">$</span><span class="kw">fit</span>, <span class="kw">nile</span><span class="op">$</span><span class="kw">fit</span>, <span class="kw">npregiv</span><span class="op">$</span><span class="kw">fit</span>),
                                  ftrue = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw">f.new</span>, <span class="fl">3</span>),
                                  method = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"OLS"</span>, <span class="st">"NILE"</span>, <span class="st">"NPREGIV"</span>), each = <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)),
                                  lambda.star = <span class="kw">nile</span><span class="op">$</span><span class="kw">lambda</span>,
                                  alphaA = <span class="kw">alphaA</span>,
                                  alphaH = <span class="kw">alphaH</span>,
                                  alphaEps = <span class="kw">alphaEps</span>,
                                  qXmin = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">qX</span>),
                                  qXmax = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">qX</span>),
                                  suppXmin = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">suppX</span>),
                                  suppXmax = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">suppX</span>),
                                  experiment = <span class="kw">j</span>,
                                  sim = <span class="kw">i</span>)
    <span class="kw">pred.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">pred.frame</span>, <span class="kw">pred.frame.loop</span>)

    <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>(<span class="kw">meta.frame</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"varying_instrument_meta"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">SIM</span>), <span class="st">".txt"</span>), quote = <span class="fl">FALSE</span>)
    <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>(<span class="kw">pred.frame</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"varying_instrument_fit"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">SIM</span>), <span class="st">".txt"</span>), quote = <span class="fl">FALSE</span>)
  }
}
</pre></div>
<p>Once the results are saved as <code>.txt</code> files, you can produce the plots as follows.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">reshape2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">gridExtra</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>())
<span class="kw">pred.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_instrument_fit1.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_instrument_fit11.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_instrument_fit21.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_instrument_fit31.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_instrument_fit41.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_instrument_fit51.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_instrument_fit61.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_instrument_fit71.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_instrument_fit81.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"varying_instrument_fit91.txt"</span>, header = <span class="fl">TRUE</span>))

<span class="kw">pred.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">pred.frame</span>, <span class="kw">experiment</span> <span class="op">&lt;=</span> <span class="fl">3</span>)

<span class="kw">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">pred.frame</span>)
<span class="kw">n.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">x</span>))
<span class="kw">n.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">method</span>))
<span class="kw">n.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">sim</span>))
<span class="kw">n.exp</span> <span class="op">&lt;-</span> <span class="kw">n</span><span class="op">/</span>(<span class="kw">n.x</span><span class="op">*</span><span class="kw">n.m</span><span class="op">*</span><span class="kw">n.sim</span>)

<span class="kw">var_xi_Y</span> <span class="op">&lt;-</span> (<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>)<span class="op">*</span>(<span class="fl">.3</span><span class="op">^</span><span class="fl">2</span><span class="op">+</span><span class="fl">.2</span><span class="op">^</span><span class="fl">2</span>)

<span class="co"># pred.frame &lt;- subset(pred.frame, method != "IV")</span>
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">sq.err</span> <span class="op">&lt;-</span> (<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">fhat</span><span class="op">-</span><span class="kw">pred.frame</span><span class="op">$</span><span class="kw">ftrue</span>)<span class="op">^</span><span class="fl">2</span>
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">x.abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">x</span>),<span class="fl">2</span>)
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">alphaA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">alphaA</span>,<span class="fl">3</span>)
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">alphaH</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">alphaH</span>,<span class="fl">3</span>)
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">alphaEps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">alphaEps</span>,<span class="fl">3</span>)
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">qXmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">qXmax</span>,<span class="fl">3</span>)
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">lambda.star</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">lambda.star</span>,<span class="fl">3</span>)
<span class="kw">error.frame.x.abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(<span class="kw">sq.err</span> <span class="op">~</span> <span class="kw">method</span> <span class="op">+</span> <span class="kw">alphaA</span> <span class="op">+</span> <span class="kw">qXmax</span> <span class="op">+</span> <span class="kw">x.abs</span> <span class="op">+</span> <span class="kw">sim</span>, <span class="kw">pred.frame</span>, <span class="kw">mean</span>)
<span class="kw">error.frame.x.abs</span> <span class="op">&lt;-</span> <span class="kw">error.frame.x.abs</span>[<span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">method</span>, <span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">alphaA</span>, <span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">sim</span>),]
<span class="kw">n.x.abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">x.abs</span>))
<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">worst.case.mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">error.frame.x.abs</span>), <span class="fu">function</span>(<span class="kw">i</span>) <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">sq.err</span>[(<span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span>((<span class="kw">i</span><span class="op">-</span><span class="fl">1</span>)<span class="op">/</span><span class="kw">n.x.abs</span>)<span class="op">*</span><span class="kw">n.x.abs</span>)<span class="op">:</span><span class="kw">i</span>])) <span class="op">+</span> <span class="kw">var_xi_Y</span>

<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">alphaA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">alphaA</span>,
                                   levels = <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">alphaA</span>)),
                                   labels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"("</span>, <span class="kw">alpha</span>[<span class="kw">A</span>], <span class="st">","</span>, <span class="kw">alpha</span>[<span class="kw">H</span>], <span class="st">","</span>, <span class="kw">alpha</span>[<span class="kw">epsilon</span>], <span class="st">")  =  ("</span>, <span class="fl">0</span>,<span class="st">","</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>),<span class="st">","</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">2</span><span class="op">/</span><span class="fl">3</span>), <span class="st">")"</span>)),
                                              <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"("</span>, <span class="kw">alpha</span>[<span class="kw">A</span>],<span class="st">","</span>, <span class="kw">alpha</span>[<span class="kw">H</span>],<span class="st">","</span>, <span class="kw">alpha</span>[<span class="kw">epsilon</span>], <span class="st">")  =  ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span><span class="op">/</span><span class="fl">6</span>),<span class="st">","</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>),<span class="st">","</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span><span class="op">/</span><span class="fl">2</span>), <span class="st">")"</span>)),
                                              <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"("</span>, <span class="kw">alpha</span>[<span class="kw">A</span>], <span class="st">","</span>,<span class="kw">alpha</span>[<span class="kw">H</span>],<span class="st">","</span>, <span class="kw">alpha</span>[<span class="kw">epsilon</span>], <span class="st">")  =  ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>),<span class="st">","</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>),<span class="st">","</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>), <span class="st">")"</span>))))

<span class="kw">error.frame.x.abs.avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(<span class="kw">worst.case.mse</span> <span class="op">~</span> <span class="kw">method</span> <span class="op">+</span> <span class="kw">alphaA</span> <span class="op">+</span> <span class="kw">qXmax</span> <span class="op">+</span> <span class="kw">x.abs</span>, <span class="kw">error.frame.x.abs</span>, <span class="kw">mean</span>)
<span class="kw">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">error.frame.x.abs.avg</span>, <span class="kw">method</span> <span class="op">==</span> <span class="st">"OLS"</span>)
<span class="kw">tmp</span><span class="op">$</span><span class="kw">worst.case.mse</span> <span class="op">&lt;-</span> <span class="kw">var_xi_Y</span>
<span class="kw">tmp</span><span class="op">$</span><span class="kw">method</span> <span class="op">&lt;-</span> <span class="st">"ORACLE"</span>
<span class="kw">error.frame.x.abs.avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">error.frame.x.abs.avg</span>, <span class="kw">tmp</span>)

<span class="kw">error.frame.x.abs.avg</span><span class="op">$</span><span class="kw">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">sim</span><span class="op">+</span><span class="fl">1</span>)
<span class="kw">error.frame.x.abs.avg</span><span class="op">$</span><span class="kw">sq.err</span> <span class="op">&lt;-</span> <span class="fl">NA</span>
<span class="kw">error.frame.x.abs.avg</span><span class="op">$</span><span class="kw">avg</span> <span class="op">&lt;-</span> <span class="fl">TRUE</span>
<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">avg</span> <span class="op">&lt;-</span> <span class="fl">FALSE</span>
<span class="kw">error.frame.x.abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">error.frame.x.abs</span>, <span class="kw">error.frame.x.abs.avg</span>)

<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">method</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">method</span>,
                                   levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"OLS"</span>, <span class="st">"NILE"</span>, <span class="st">"NPREGIV"</span>, <span class="st">"ORACLE"</span>))


<span class="kw">qX.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">error.frame.x.abs.avg</span>, <span class="kw">method</span> <span class="op">==</span> <span class="st">"OLS"</span> <span class="op">&amp;</span> <span class="kw">x.abs</span> <span class="op">==</span> <span class="fl">2</span>)
<span class="kw">rects1</span> <span class="op">&lt;-</span> <span class="kw">qX.frame</span>
<span class="kw">rects1</span><span class="op">$</span><span class="kw">xstart</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="kw">rects1</span><span class="op">$</span><span class="kw">xend</span> <span class="op">&lt;-</span> <span class="kw">rects1</span><span class="op">$</span><span class="kw">qXmax</span>
<span class="kw">rects2</span> <span class="op">&lt;-</span> <span class="kw">qX.frame</span>
<span class="kw">rects2</span><span class="op">$</span><span class="kw">xstart</span> <span class="op">&lt;-</span> <span class="kw">rects2</span><span class="op">$</span><span class="kw">qXmax</span>
<span class="kw">rects2</span><span class="op">$</span><span class="kw">xend</span> <span class="op">&lt;-</span> <span class="fl">2</span>
<span class="kw">rects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">rects1</span>, <span class="kw">rects2</span>)
<span class="kw">rects</span><span class="op">$</span><span class="kw">col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, each=<span class="kw">n.exp</span>))


<span class="kw">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() <span class="op">+</span>
  <span class="co"># geom_density(data=df.plt, aes(x=x.plt),alpha=.5) +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_rect</a></span>(data = <span class="kw">rects</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(xmin = <span class="kw">xstart</span>, xmax = <span class="kw">xend</span>, ymin = <span class="op">-</span><span class="fl">Inf</span>, ymax = <span class="fl">Inf</span>, fill=<span class="kw">col</span>), alpha=<span class="fl">.1</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(data=<span class="kw">error.frame.x.abs</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x.abs</span>, <span class="kw">worst.case.mse</span>, col=<span class="kw">method</span>, lty = <span class="kw">method</span>, group = <span class="fu"><a href="https://rdrr.io/r/base/interaction.html">interaction</a></span>(<span class="kw">method</span>,<span class="kw">sim</span>,<span class="kw">avg</span>), alpha=<span class="kw">avg</span>, size = <span class="kw">avg</span>)) <span class="op">+</span>
  <span class="co">#geom_line(data=error.frame.x.abs.avg, aes(x.abs, worst.case.mse, col=method, lty = method), size=1) +</span>
  <span class="co"># facet_wrap(. ~ alphaA + alphaH + alphaEps, ncol=5) +</span>
  <span class="co"># geom_vline(aes(xintercept = qXmax),lty=2) +</span>
  <span class="co"># geom_hline(yintercept = var_xi_Y,lty=2, col = "black") +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="kw">.</span> <span class="op">~</span> <span class="kw">alphaA</span>, labeller = <span class="kw">label_parsed</span>) <span class="op">+</span>
  <span class="co"># ggtitle(expression(paste("constant instrument strength alpha_A = ", 1/sqrt(3)))) +</span>
  <span class="co"># ggtitle(expression(paste("constant instrument strength ", alpha[A], " = ", sqrt(1/3)))) +</span>
  <span class="co"># gtitle("generalization performance for different confounding strength") +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_size_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.2</span>, <span class="fl">1</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_alpha_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.2</span>, <span class="fl">1</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#D55E00"</span>,
                                <span class="co">#"#0072B2",</span>
                                <span class="st">"#0072B2"</span>, <span class="st">"#CC79A7"</span>, <span class="st">"#009E73"</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_linetype_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"solid"</span>,<span class="fl">3</span>), <span class="st">"dashed"</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"black"</span>, <span class="st">"transparent"</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span>(xlim = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">2</span>), ylim = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">.3</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"generalization to interventions up to strength"</span>) <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"worst-case MSE"</span>)  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(plot.title = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(hjust=<span class="fl">0.5</span>),
        <span class="co">#legend.position = "none",</span>
        legend.background = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span>(fill = <span class="st">"transparent"</span>, colour = <span class="fl">NA</span>),
        legend.key = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span>(fill = <span class="st">"transparent"</span>, colour = <span class="fl">NA</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span>(fill=<span class="st">"none"</span>, lty= <span class="st">"none"</span>, size = <span class="st">"none"</span>, alpha = <span class="st">"none"</span>)
<span class="kw">p</span>



<span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html">pdf</a></span>(<span class="st">"varying_instrument_with_variability.pdf"</span>, width = <span class="fl">8</span>, height = <span class="fl">2.5</span>)
<span class="kw">p</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span>()
</pre></div>
</div>
<div id="figure-5---sampling-causal-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#figure-5---sampling-causal-functions" class="anchor"></a>Figure 5 - Sampling causal functions</h2>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/HenrikBengtsson/R.utils">R.utils</a></span>)
<span class="co">#&gt; Loading required package: R.oo</span>
<span class="co">#&gt; Loading required package: R.methodsS3</span>
<span class="co">#&gt; R.methodsS3 v1.8.0 (2020-02-14 07:10:20 UTC) successfully loaded. See ?R.methodsS3 for help.</span>
<span class="co">#&gt; R.oo v1.23.0 successfully loaded. See ?R.oo for help.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'R.oo'</span>
<span class="co">#&gt; The following object is masked from 'package:R.methodsS3':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     throw</span>
<span class="co">#&gt; The following objects are masked from 'package:methods':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     getClasses, getMethods</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     attach, detach, load, save</span>
<span class="co">#&gt; R.utils v2.9.2 successfully loaded. See ?R.utils for help.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'R.utils'</span>
<span class="co">#&gt; The following object is masked from 'package:utils':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     timestamp</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     cat, commandArgs, getOption, inherits, isOpen, nullfile, parse,</span>
<span class="co">#&gt;     warnings</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">splines</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>())


<span class="kw">alphaA</span> <span class="op">&lt;-</span> <span class="kw">alphaH</span> <span class="op">&lt;-</span> <span class="kw">alphaEps</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">3</span>)
<span class="co">## quantiles for different settings</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)
<span class="kw">N</span> <span class="op">&lt;-</span> <span class="fl">100000</span>
<span class="kw">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">X</span> <span class="op">&lt;-</span> <span class="kw">alphaA</span><span class="op">*</span><span class="kw">A</span> <span class="op">+</span> <span class="kw">alphaH</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="kw">alphaEps</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="kw">X</span>, probs = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.05</span>,<span class="fl">.95</span>))
<span class="kw">qX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)<span class="op">*</span>(<span class="kw">q</span>[<span class="fl">2</span>]<span class="op">-</span><span class="kw">q</span>[<span class="fl">1</span>])<span class="op">/</span><span class="fl">2</span>
<span class="kw">suppX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)<span class="op">*</span>(<span class="kw">alphaA</span> <span class="op">+</span> <span class="kw">alphaH</span> <span class="op">+</span> <span class="kw">alphaEps</span>)

<span class="kw">n.splines.true</span> <span class="op">&lt;-</span> <span class="fl">4</span>
<span class="kw">fX</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">x</span>=<span class="kw">x.new</span>, <span class="kw">qx</span>=<span class="kw">qX</span>, <span class="kw">beta</span>=<span class="kw">beta</span>){
  <span class="kw">bx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html">ns</a></span>(<span class="kw">x</span>, knots = <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(from=<span class="kw">qx</span>[<span class="fl">1</span>], to=<span class="kw">qx</span>[<span class="fl">2</span>], length.out=(<span class="kw">n.splines.true</span><span class="op">+</span><span class="fl">1</span>))[<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="kw">n.splines.true</span><span class="op">+</span><span class="fl">1</span>)], Boundary.knots = <span class="kw">qx</span>)
  <span class="kw">bx</span><span class="op">%*%</span><span class="kw">beta</span>
}

<span class="kw">x.new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="fl">2</span>,<span class="fl">2</span>,length.out = <span class="fl">100</span>)
<span class="kw">n</span> <span class="op">&lt;-</span> <span class="fl">200</span>
<span class="kw">Nsim</span> <span class="op">&lt;-</span> <span class="fl">18</span>
<span class="kw">df.data</span> <span class="op">&lt;-</span> <span class="kw">df.ftrue</span> <span class="op">&lt;-</span> <span class="kw">NULL</span>
<span class="kw">k</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="co">for</span>(<span class="kw">i</span> <span class="co">in</span> <span class="fl">1</span><span class="op">:</span><span class="kw">Nsim</span>){
  <span class="kw">k</span> <span class="op">&lt;-</span> <span class="kw">k</span><span class="op">+</span><span class="fl">1</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="kw">k</span>)
  <span class="kw">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n.splines.true</span>, <span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
  <span class="kw">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
  <span class="kw">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
  <span class="kw">X</span> <span class="op">&lt;-</span> <span class="kw">alphaA</span><span class="op">*</span><span class="kw">A</span> <span class="op">+</span> <span class="kw">alphaH</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="kw">alphaEps</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
  <span class="kw">Y</span> <span class="op">&lt;-</span> <span class="fu">fX</span>(<span class="kw">X</span>,<span class="kw">qX</span>,<span class="kw">beta</span>) <span class="op">+</span> <span class="fl">.3</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="fl">.2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)

  <span class="kw">f.new</span> <span class="op">&lt;-</span> <span class="fu">fX</span>(<span class="kw">x.new</span>,<span class="kw">qX</span>,<span class="kw">beta</span>)
  <span class="kw">df.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">df.data</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(x=<span class="kw">X</span>, y=<span class="kw">Y</span>, sim = <span class="kw">i</span>))
  <span class="kw">df.ftrue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">df.ftrue</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(x=<span class="kw">x.new</span>, f=<span class="kw">f.new</span>, sim = <span class="kw">i</span>))
}

<span class="kw">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(data=<span class="kw">df.data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span>,<span class="kw">y</span>), alpha = <span class="fl">.7</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(data=<span class="kw">df.ftrue</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span>, <span class="kw">f</span>), col = <span class="st">"#009E73"</span>, size = <span class="fl">1</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(xintercept = <span class="kw">qX</span>, lty=<span class="fl">2</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="kw">.</span><span class="op">~</span><span class="kw">sim</span>, nrow=<span class="fl">3</span>)
<span class="kw">p</span>
</pre></div>
<p><img src="vgn_reproduce_results_files/figure-html/plot-causal-funcs-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div id="figure-6---varying-curvature" class="section level2">
<h2 class="hasAnchor">
<a href="#figure-6---varying-curvature" class="anchor"></a>Figure 6 - Varying curvature</h2>
<p>This experiment is computationally intensive, therefore it is advisable to run it in parallel. The number of simulations is 100, so one strategy is to run it in chunks of 10 simulations at a time.</p>
<p>For example, the first chunk of simulations can be run as follows.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="kw">SIM</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>
</pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/runesen/NILE">NILE</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/HenrikBengtsson/R.utils">R.utils</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">splines</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">np</span>)
<span class="co"># X has fixed variance 1/3</span>
<span class="kw">n</span> <span class="op">&lt;-</span> <span class="fl">200</span>
<span class="kw">fact</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># three times the desired variance of X</span>
<span class="kw">df.X</span> <span class="op">&lt;-</span> <span class="fl">50</span>
<span class="co">## missing settings</span>
<span class="kw">alphaA</span> <span class="op">&lt;-</span> <span class="kw">alphaH</span> <span class="op">&lt;-</span> <span class="kw">alphaEps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="kw">fact</span><span class="op">/</span><span class="fl">3</span>)
<span class="co">## quantiles for different settings</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)
<span class="kw">N</span> <span class="op">&lt;-</span> <span class="fl">100000</span>
<span class="kw">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">X</span> <span class="op">&lt;-</span> <span class="kw">alphaA</span><span class="op">*</span><span class="kw">A</span> <span class="op">+</span> <span class="kw">alphaH</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="kw">alphaEps</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">N</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
<span class="kw">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="kw">X</span>, probs = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.05</span>,<span class="fl">.95</span>))
<span class="kw">qX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)<span class="op">*</span>(<span class="kw">q</span>[<span class="fl">2</span>]<span class="op">-</span><span class="kw">q</span>[<span class="fl">1</span>])<span class="op">/</span><span class="fl">2</span>
<span class="kw">suppX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)<span class="op">*</span>(<span class="kw">alphaA</span> <span class="op">+</span> <span class="kw">alphaH</span> <span class="op">+</span> <span class="kw">alphaEps</span>)

<span class="kw">n.exp</span> <span class="op">&lt;-</span> <span class="fl">5</span>
<span class="kw">curv.max.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">4</span>, length.out = <span class="kw">n.exp</span>)

<span class="kw">n.splines.true</span> <span class="op">&lt;-</span> <span class="fl">4</span>
<span class="kw">fX</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">x</span>, <span class="kw">qx</span>, <span class="kw">beta</span>, <span class="kw">curv</span>){
  <span class="kw">wlo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">x</span> <span class="op">&lt;</span> <span class="kw">qx</span>[<span class="fl">1</span>])
  <span class="kw">wup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">x</span> <span class="op">&gt;</span> <span class="kw">qx</span>[<span class="fl">2</span>])
  <span class="kw">curv.term</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x</span>))
  <span class="kw">curv.term</span>[<span class="kw">wlo</span>] <span class="op">&lt;-</span> <span class="fl">.5</span><span class="op">*</span><span class="kw">curv</span>[<span class="fl">1</span>]<span class="op">*</span>(<span class="kw">x</span>[<span class="kw">wlo</span>]<span class="op">-</span><span class="kw">qx</span>[<span class="fl">1</span>])<span class="op">^</span><span class="fl">2</span>
  <span class="kw">curv.term</span>[<span class="kw">wup</span>] <span class="op">&lt;-</span> <span class="fl">.5</span><span class="op">*</span><span class="kw">curv</span>[<span class="fl">2</span>]<span class="op">*</span>(<span class="kw">x</span>[<span class="kw">wup</span>]<span class="op">-</span><span class="kw">qx</span>[<span class="fl">2</span>])<span class="op">^</span><span class="fl">2</span>
  <span class="kw">bx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html">ns</a></span>(<span class="kw">x</span>, knots = <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(from=<span class="kw">qx</span>[<span class="fl">1</span>], to=<span class="kw">qx</span>[<span class="fl">2</span>], length.out=(<span class="kw">n.splines.true</span><span class="op">+</span><span class="fl">1</span>))[<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="kw">n.splines.true</span><span class="op">+</span><span class="fl">1</span>)], Boundary.knots = <span class="kw">qx</span>)
  <span class="kw">lin.term</span> <span class="op">&lt;-</span> <span class="kw">bx</span><span class="op">%*%</span><span class="kw">beta</span>
  <span class="kw">lin.term</span> <span class="op">+</span> <span class="kw">curv.term</span>
}

<span class="co"># curv.max &lt;- .5</span>
<span class="co"># curv &lt;- runif(2,min=-curv.max,max=curv.max)</span>
<span class="co"># beta &lt;- runif(n.splines.true, -1,1)</span>
<span class="co"># x.new &lt;- seq(-2,2,length.out = 100)</span>
<span class="co"># f.new &lt;- fX(x.new,qX,beta,curv)</span>
<span class="co"># plot(x.new, f.new)</span>
<span class="co"># abline(v=qx)</span>

<span class="kw">pred.frame</span> <span class="op">&lt;-</span> <span class="kw">NULL</span>
<span class="kw">x.new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="fl">2</span>,<span class="fl">2</span>,length.out = <span class="fl">100</span>)
<span class="kw">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">SIM</span>)<span class="op">*</span><span class="kw">n.exp</span>
<span class="co">for</span>(<span class="kw">i</span> <span class="co">in</span> <span class="kw">SIM</span>){
  <span class="co">for</span>(<span class="kw">j</span> <span class="co">in</span> <span class="fl">1</span><span class="op">:</span><span class="kw">n.exp</span>){
    <span class="kw">k</span> <span class="op">&lt;-</span> <span class="kw">k</span><span class="op">+</span><span class="fl">1</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="kw">k</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"sim = "</span>, <span class="kw">i</span>, <span class="st">", curv.max.seq = "</span>, <span class="kw">j</span>))
    <span class="kw">curv.max</span> <span class="op">&lt;-</span> <span class="kw">curv.max.seq</span>[<span class="kw">j</span>]
    <span class="kw">curv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">2</span>,min=<span class="op">-</span><span class="kw">curv.max</span>,max=<span class="kw">curv.max</span>)
    <span class="kw">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n.splines.true</span>, <span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">X</span> <span class="op">&lt;-</span> <span class="kw">alphaA</span><span class="op">*</span><span class="kw">A</span> <span class="op">+</span> <span class="kw">alphaH</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="kw">alphaEps</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">Y</span> <span class="op">&lt;-</span> <span class="fu">fX</span>(<span class="kw">X</span>,<span class="kw">qX</span>,<span class="kw">beta</span>,<span class="kw">curv</span>) <span class="op">+</span> <span class="fl">.3</span><span class="op">*</span><span class="kw">H</span> <span class="op">+</span> <span class="fl">.2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>)
    <span class="kw">f.new</span> <span class="op">&lt;-</span> <span class="fu">fX</span>(<span class="kw">x.new</span>,<span class="kw">qX</span>,<span class="kw">beta</span>,<span class="kw">curv</span>)

    <span class="co"># fit.nile &lt;- tryCatch({withTimeout({NILE(Y=Y,X=X,A=A,lambda.star="PULSE",df=df.X,x.new=x.new,plot=FALSE)$pred}, timeout = 180, onTimeout = "error")},</span>
    <span class="co">#                      error=function(e){</span>
    <span class="co">#                        print(paste("ERROR NILE: ", e))</span>
    <span class="co">#                        rep(NA, length(x.new))</span>
    <span class="co">#                      })</span>
    <span class="kw">nile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({<span class="fu"><a href="https://rdrr.io/pkg/R.utils/man/withTimeout.html">withTimeout</a></span>({<span class="fu"><a href="../reference/NILE.html">NILE</a></span>(Y=<span class="kw">Y</span>,X=<span class="kw">X</span>,A=<span class="kw">A</span>,lambda.star=<span class="st">"test"</span>,df=<span class="kw">df.X</span>,x.new=<span class="kw">x.new</span>,plot=<span class="fl">FALSE</span>)}, timeout = <span class="fl">180</span>, onTimeout = <span class="st">"error"</span>)},
                     error=<span class="fu">function</span>(<span class="kw">e</span>){
                       <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ERROR NILE: "</span>, <span class="kw">e</span>))
                       <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(pred = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)), lambda.star = <span class="fl">NA</span>)
                     })
    <span class="kw">fit.nile</span> <span class="op">&lt;-</span> <span class="kw">nile</span><span class="op">$</span><span class="kw">pred</span>
    <span class="kw">lambda.star</span> <span class="op">&lt;-</span> <span class="kw">nile</span><span class="op">$</span><span class="kw">lambda.star</span>

    <span class="kw">fit.ols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({<span class="fu"><a href="https://rdrr.io/pkg/R.utils/man/withTimeout.html">withTimeout</a></span>({<span class="fu"><a href="../reference/NILE.html">NILE</a></span>(Y=<span class="kw">Y</span>,X=<span class="kw">X</span>,A=<span class="kw">A</span>,lambda.star=<span class="fl">0</span>,df=<span class="kw">df.X</span>,x.new=<span class="kw">x.new</span>,plot=<span class="fl">FALSE</span>,par.a=<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(lambda=<span class="fl">0.1</span>))<span class="op">$</span><span class="kw">pred</span>}, timeout = <span class="fl">180</span>, onTimeout = <span class="st">"error"</span>)},
                        error=<span class="fu">function</span>(<span class="kw">e</span>){
                          <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ERROR OLS: "</span>, <span class="kw">e</span>))
                          <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>))
                        })
    <span class="kw">fit.iv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({<span class="fu"><a href="https://rdrr.io/pkg/R.utils/man/withTimeout.html">withTimeout</a></span>({<span class="fu"><a href="../reference/NILE.html">NILE</a></span>(Y=<span class="kw">Y</span>,X=<span class="kw">X</span>,A=<span class="kw">A</span>,lambda.star=<span class="fl">Inf</span>,df=<span class="kw">df.X</span>,x.new=<span class="kw">x.new</span>,plot=<span class="fl">FALSE</span>)<span class="op">$</span><span class="kw">pred</span>}, timeout = <span class="fl">180</span>, onTimeout = <span class="st">"error"</span>)},
                       error=<span class="fu">function</span>(<span class="kw">e</span>){
                         <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ERROR IV: "</span>, <span class="kw">e</span>))
                         <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>))
                       })
    <span class="kw">fit.npregiv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({<span class="fu"><a href="https://rdrr.io/pkg/R.utils/man/withTimeout.html">withTimeout</a></span>({<span class="fu">npregiv</span>(y=<span class="kw">Y</span>,z=<span class="kw">X</span>,w=<span class="kw">A</span>,zeval=<span class="kw">x.new</span>)<span class="op">$</span><span class="kw">phi.eval</span>}, timeout = <span class="fl">180</span>, onTimeout = <span class="st">"error"</span>)},
                            error=<span class="fu">function</span>(<span class="kw">e</span>){
                              <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ERROR NPREGIV: "</span>, <span class="kw">e</span>))
                              <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>))
                            })

    <span class="kw">pred.frame.loop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(x = <span class="kw">x.new</span>,
                                  fhat = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">fit.ols</span>, <span class="kw">fit.nile</span>, <span class="kw">fit.iv</span>, <span class="kw">fit.npregiv</span>),
                                  ftrue = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw">f.new</span>, <span class="fl">4</span>),
                                  method = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"OLS"</span>, <span class="st">"NILE"</span>, <span class="st">"IV"</span>, <span class="st">"NPREGIV"</span>), each = <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x.new</span>)),
                                  lambda.star = <span class="kw">lambda.star</span>,
                                  alphaA = <span class="kw">alphaA</span>,
                                  alphaH = <span class="kw">alphaH</span>,
                                  alphaEps = <span class="kw">alphaEps</span>,
                                  qXmin = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">qX</span>),
                                  qXmax = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">qX</span>),
                                  suppXmin = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">suppX</span>),
                                  suppXmax = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">suppX</span>),
                                  curv.max = <span class="kw">curv.max</span>,
                                  sim = <span class="kw">i</span>)
    <span class="kw">pred.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">pred.frame</span>, <span class="kw">pred.frame.loop</span>)
    <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span>(<span class="kw">pred.frame</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"nz_curvature_strong"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">SIM</span>), <span class="st">".txt"</span>), quote = <span class="fl">FALSE</span>)
  }
}
</pre></div>
<p>Once the results are saved as <code>.txt</code> files, you can produce the plots as follows.</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">reshape2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">gridExtra</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>())
<span class="kw">pred.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"nz_curvature_strong1.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"nz_curvature_strong11.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"nz_curvature_strong21.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"nz_curvature_strong31.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"nz_curvature_strong41.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"nz_curvature_strong51.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"nz_curvature_strong61.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"nz_curvature_strong71.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"nz_curvature_strong81.txt"</span>, header = <span class="fl">TRUE</span>),
                    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="st">"nz_curvature_strong91.txt"</span>, header = <span class="fl">TRUE</span>))

<span class="kw">pred.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">pred.frame</span>, <span class="kw">method</span> != <span class="st">"IV"</span>)
<span class="kw">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">pred.frame</span>)
<span class="kw">n.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">x</span>))
<span class="kw">n.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">method</span>))
<span class="kw">n.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">sim</span>))
<span class="kw">n.exp</span> <span class="op">&lt;-</span> <span class="kw">n</span><span class="op">/</span>(<span class="kw">n.x</span><span class="op">*</span><span class="kw">n.m</span><span class="op">*</span><span class="kw">n.sim</span>)

<span class="kw">var_xi_Y</span> <span class="op">&lt;-</span> (<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>)<span class="op">*</span>(<span class="fl">.3</span><span class="op">^</span><span class="fl">2</span><span class="op">+</span><span class="fl">.2</span><span class="op">^</span><span class="fl">2</span>)

<span class="co"># pred.frame &lt;- subset(pred.frame, method != "IV")</span>
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">sq.err</span> <span class="op">&lt;-</span> (<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">fhat</span><span class="op">-</span><span class="kw">pred.frame</span><span class="op">$</span><span class="kw">ftrue</span>)<span class="op">^</span><span class="fl">2</span>
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">x.abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">x</span>),<span class="fl">2</span>)
<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">curv.max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pred.frame</span><span class="op">$</span><span class="kw">curv.max</span>,<span class="fl">1</span>)
<span class="kw">error.frame.x.abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(<span class="kw">sq.err</span> <span class="op">~</span> <span class="kw">method</span> <span class="op">+</span> <span class="kw">curv.max</span> <span class="op">+</span> <span class="kw">qXmax</span> <span class="op">+</span> <span class="kw">x.abs</span> <span class="op">+</span> <span class="kw">sim</span>, <span class="kw">pred.frame</span>, <span class="kw">mean</span>)
<span class="kw">error.frame.x.abs</span> <span class="op">&lt;-</span> <span class="kw">error.frame.x.abs</span>[<span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">method</span>, <span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">curv.max</span>, <span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">sim</span>, <span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">x.abs</span>),]
<span class="kw">n.x.abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">x.abs</span>))
<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">worst.case.mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">error.frame.x.abs</span>), <span class="fu">function</span>(<span class="kw">i</span>) <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">sq.err</span>[(<span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span>((<span class="kw">i</span><span class="op">-</span><span class="fl">1</span>)<span class="op">/</span><span class="kw">n.x.abs</span>)<span class="op">*</span><span class="kw">n.x.abs</span>)<span class="op">:</span><span class="kw">i</span>])) <span class="op">+</span> <span class="kw">var_xi_Y</span>

<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">curv.max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">curv.max</span>,
                                         levels = <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">curv.max</span>)),
                                         labels = <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">curv.max</span>)), <span class="fu">function</span>(<span class="kw">c</span>) <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"max. curvature = "</span>, <span class="kw">c</span>)))

<span class="kw">error.frame.x.abs.avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(<span class="kw">worst.case.mse</span> <span class="op">~</span> <span class="kw">method</span> <span class="op">+</span> <span class="kw">curv.max</span> <span class="op">+</span> <span class="kw">qXmax</span> <span class="op">+</span> <span class="kw">x.abs</span>, <span class="kw">error.frame.x.abs</span>, <span class="kw">mean</span>)
<span class="kw">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">error.frame.x.abs.avg</span>, <span class="kw">method</span> <span class="op">==</span> <span class="st">"OLS"</span>)
<span class="kw">tmp</span><span class="op">$</span><span class="kw">worst.case.mse</span> <span class="op">&lt;-</span> <span class="kw">var_xi_Y</span>
<span class="kw">tmp</span><span class="op">$</span><span class="kw">method</span> <span class="op">&lt;-</span> <span class="st">"ORACLE"</span>
<span class="kw">error.frame.x.abs.avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">error.frame.x.abs.avg</span>, <span class="kw">tmp</span>)

<span class="kw">error.frame.x.abs.avg</span><span class="op">$</span><span class="kw">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">sim</span><span class="op">+</span><span class="fl">1</span>)
<span class="kw">error.frame.x.abs.avg</span><span class="op">$</span><span class="kw">sq.err</span> <span class="op">&lt;-</span> <span class="fl">NA</span>
<span class="kw">error.frame.x.abs.avg</span><span class="op">$</span><span class="kw">avg</span> <span class="op">&lt;-</span> <span class="fl">TRUE</span>
<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">avg</span> <span class="op">&lt;-</span> <span class="fl">FALSE</span>
<span class="kw">error.frame.x.abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">error.frame.x.abs</span>, <span class="kw">error.frame.x.abs.avg</span>)

<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">method</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">error.frame.x.abs</span><span class="op">$</span><span class="kw">method</span>,
                                   levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"OLS"</span>, <span class="st">"NILE"</span>, <span class="st">"NPREGIV"</span>, <span class="st">"ORACLE"</span>))

<span class="kw">qX.frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="kw">error.frame.x.abs.avg</span>, <span class="kw">method</span> <span class="op">==</span> <span class="st">"OLS"</span> <span class="op">&amp;</span> <span class="kw">x.abs</span> <span class="op">==</span> <span class="fl">2</span>)
<span class="kw">rects1</span> <span class="op">&lt;-</span> <span class="kw">qX.frame</span>
<span class="kw">rects1</span><span class="op">$</span><span class="kw">xstart</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="kw">rects1</span><span class="op">$</span><span class="kw">xend</span> <span class="op">&lt;-</span> <span class="kw">rects1</span><span class="op">$</span><span class="kw">qXmax</span>
<span class="kw">rects2</span> <span class="op">&lt;-</span> <span class="kw">qX.frame</span>
<span class="kw">rects2</span><span class="op">$</span><span class="kw">xstart</span> <span class="op">&lt;-</span> <span class="kw">rects2</span><span class="op">$</span><span class="kw">qXmax</span>
<span class="kw">rects2</span><span class="op">$</span><span class="kw">xend</span> <span class="op">&lt;-</span> <span class="fl">2</span>
<span class="kw">rects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">rects1</span>, <span class="kw">rects2</span>)
<span class="kw">rects</span><span class="op">$</span><span class="kw">col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, each=<span class="kw">n.exp</span>))

<span class="kw">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_rect</a></span>(data = <span class="kw">rects</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(xmin = <span class="kw">xstart</span>, xmax = <span class="kw">xend</span>, ymin = <span class="op">-</span><span class="fl">Inf</span>, ymax = <span class="fl">Inf</span>, fill=<span class="kw">col</span>), alpha=<span class="fl">.1</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(data=<span class="kw">error.frame.x.abs</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x.abs</span>, <span class="kw">worst.case.mse</span>, col=<span class="kw">method</span>, lty = <span class="kw">method</span>, group = <span class="fu"><a href="https://rdrr.io/r/base/interaction.html">interaction</a></span>(<span class="kw">method</span>,<span class="kw">sim</span>,<span class="kw">avg</span>), alpha=<span class="kw">avg</span>, size = <span class="kw">avg</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="kw">.</span> <span class="op">~</span> <span class="kw">curv.max</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_size_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.15</span>, <span class="fl">.85</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_alpha_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.15</span>, <span class="fl">.85</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#D55E00"</span>,
                                <span class="co">#"#0072B2",</span>
                                <span class="st">"#0072B2"</span>, <span class="st">"#CC79A7"</span>, <span class="st">"#009E73"</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_linetype_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"solid"</span>,<span class="fl">3</span>), <span class="st">"dashed"</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"black"</span>, <span class="st">"transparent"</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span>(xlim = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">2</span>), ylim = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">.3</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"generalization to interventions up to strength"</span>) <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"worst-case MSE"</span>)  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(plot.title = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(hjust=<span class="fl">0.5</span>),
        <span class="co">#legend.position = "none",</span>
        legend.background = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span>(fill = <span class="st">"transparent"</span>, colour = <span class="fl">NA</span>),
        legend.key = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span>(fill = <span class="st">"transparent"</span>, colour = <span class="fl">NA</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span>(fill=<span class="st">"none"</span>, lty= <span class="st">"none"</span>, size = <span class="st">"none"</span>, alpha = <span class="st">"none"</span>)
<span class="kw">p</span>


<span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html">pdf</a></span>(<span class="st">"varying_extrapolation_curvature_with_variability.pdf"</span>, width = <span class="fl">10</span>, height = <span class="fl">2.2</span>)
<span class="kw">p</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span>()
</pre></div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-rune2020">
<p>Christiansen, R., Pfister, N., Jakobsen, M. E., Gnecco, N., &amp; Peters, J. (2020). <em>The difficult task of distribution generalization in nonlinear models</em>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Rune Christiansen, Niklas Pfister, Martin Emil Jakobsen, Nicola Gnecco, Jonas Peters.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
